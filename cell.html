<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <title>GKC Íµ¨Ïó≠Í¥ÄÎ¶¨</title>
    <link rel="manifest" href="manifest-cell.json">
    <link rel="apple-touch-icon" href="https://sacglory.church/icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            color: #333;
        }
        
        /* Ìó§Îçî */
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
        }
        
        /* Î©îÏù∏ Ïª®ÌÖêÏ∏† */
        .main-content {
            padding-top: 70px;
            padding-bottom: 80px;
            min-height: 100vh;
        }
        
        /* Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 70px);
            padding: 20px;
        }
        
        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            width: 100%;
            max-width: 350px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .login-logo {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .login-title {
            font-size: 1.5em;
            color: #4f46e5;
            margin-bottom: 30px;
            font-weight: 700;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-label {
            display: block;
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(79, 70, 229, 0.4);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        /* ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
        .tab-nav {
            display: flex;
            background: white;
            padding: 10px;
            gap: 10px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: #f1f5f9;
            border-radius: 12px;
            font-size: 0.85em;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: #64748b;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }
        
        .tab-icon {
            font-size: 1.3em;
        }
        
        /* Ïπ¥Îìú */
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .card-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Íµ¨Ïó≠ ÏÑ†ÌÉù */
        .cell-selector {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .cell-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1em;
            background: white;
        }
        
        /* Ï∂úÏÑù Ï≤¥ÌÅ¨ Î¶¨Ïä§Ìä∏ */
        .member-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            gap: 15px;
        }
        
        .member-item:last-child {
            border-bottom: none;
        }
        
        .member-checkbox {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            cursor: pointer;
            accent-color: #4f46e5;
        }
        
        .member-info {
            flex: 1;
        }
        
        .member-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 1em;
        }
        
        .member-phone {
            font-size: 0.85em;
            color: #64748b;
            margin-top: 3px;
        }
        
        .member-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .status-present {
            background: #dcfce7;
            color: #16a34a;
        }
        
        .status-absent {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .reason-btn {
            background: #fef3c7;
            color: #d97706;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            cursor: pointer;
        }
        
        /* ÌÜµÍ≥Ñ */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5em;
            font-weight: 700;
            color: #4f46e5;
        }
        
        .stat-label {
            font-size: 0.75em;
            color: #64748b;
            margin-top: 5px;
        }
        
        /* Î≥¥Í≥†ÏÑú Ìèº */
        .report-form {
            padding: 15px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .form-textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1em;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: #4f46e5;
        }
        
        /* Î≥¥Í≥†ÏÑú Î™©Î°ù (Í¥ÄÎ¶¨ÏûêÏö©) */
        .report-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            gap: 15px;
        }
        
        .report-cell {
            font-weight: 600;
            color: #1e293b;
            min-width: 80px;
        }
        
        .report-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .report-submitted {
            background: #dcfce7;
            color: #16a34a;
        }
        
        .report-pending {
            background: #fef3c7;
            color: #d97706;
        }
        
        .report-view-btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            cursor: pointer;
        }
        
        /* ÎÇ†Ïßú ÏÑ†ÌÉù */
        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            margin: 15px;
        }
        
        .date-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }
        
        /* Î™®Îã¨ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 1.2em;
            color: #1e293b;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #64748b;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* ÏïåÎ¶º ÌÜ†Ïä§Ìä∏ */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 0.9em;
            z-index: 300;
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .toast.show {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        /* Ïà®ÍπÄ */
        .hidden {
            display: none !important;
        }
        
        /* Ïò§ÌîÑÎùºÏù∏ ÏÉÅÌÉú */
        body.offline .header {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }
        
        body.offline .header::after {
            content: 'üì¥ Ïò§ÌîÑÎùºÏù∏';
            position: absolute;
            right: 100px;
            font-size: 0.75em;
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 10px;
        }
        
        /* Í¥ÄÎ¶¨Ïûê Ï†ÑÏ≤¥ ÌòÑÌô© */
        .overview-card {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border-radius: 16px;
            padding: 20px;
            margin: 15px;
        }
        
        .overview-title {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .overview-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .overview-stat {
            text-align: center;
        }
        
        .overview-number {
            font-size: 2em;
            font-weight: 700;
        }
        
        .overview-label {
            font-size: 0.8em;
            opacity: 0.8;
        }
        
        /* ÌîÑÎ°úÍ∑∏Î†àÏä§ Î∞î */
        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 4px;
            transition: width 0.5s;
        }
        
        /* Í∏∞ÎèÑÏ†úÎ™© ÏïÑÏù¥ÌÖú */
        .prayer-item {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }
        
        .prayer-name {
            font-weight: 600;
            color: #92400e;
            font-size: 0.85em;
        }
        
        .prayer-content {
            color: #78350f;
            margin-top: 5px;
        }
        
        /* Ïó∞ÎùΩÏ≤ò ÎßÅÌÅ¨ */
        .phone-link {
            color: #4f46e5;
            text-decoration: none;
        }
        
        /* Îπà ÏÉÅÌÉú */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
        }
        
        .empty-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- Ìó§Îçî -->
    <div class="header">
        <h1>üìç GKC Íµ¨Ïó≠Í¥ÄÎ¶¨</h1>
        <button class="header-btn" id="logoutBtn" onclick="logout()" style="display: none;">Î°úÍ∑∏ÏïÑÏõÉ</button>
    </div>
    
    <!-- Î©îÏù∏ Ïª®ÌÖêÏ∏† -->
    <div class="main-content">
        <!-- Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ -->
        <div id="loginScreen" class="login-container">
            <div class="login-box">
                <div class="login-logo">‚õ™</div>
                <div class="login-title">GKC Íµ¨Ïó≠Í¥ÄÎ¶¨</div>
                <div class="form-group">
                    <label class="form-label">ÏïÑÏù¥Îîî</label>
                    <input type="text" class="form-input" id="loginUsername" placeholder="ÏïÑÏù¥Îîî ÏûÖÎ†•">
                </div>
                <div class="form-group">
                    <label class="form-label">ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•" onkeypress="if(event.key==='Enter') login()">
                </div>
                <button class="btn btn-primary" onclick="login()">Î°úÍ∑∏Ïù∏</button>
            </div>
        </div>
        
        <!-- Ïï± ÌôîÎ©¥ (Î°úÍ∑∏Ïù∏ ÌõÑ) -->
        <div id="appScreen" class="hidden">
            <!-- Íµ¨Ïó≠ ÏÑ†ÌÉù (Íµ¨Ïó≠Ïû•Ïù¥ Ïó¨Îü¨ Íµ¨Ïó≠ Îã¥Îãπ Ïãú) -->
            <div class="cell-selector" id="cellSelector">
                <select class="cell-select" id="cellSelect" onchange="onCellChange()">
                    <!-- ÎèôÏ†Å ÏÉùÏÑ± -->
                </select>
            </div>
            
            <!-- ÌÉ≠ Ïª®ÌÖêÏ∏†: Ï∂úÏÑùÏ≤¥ÌÅ¨ -->
            <div id="tabAttendance">
                <div class="date-selector">
                    <span>üìÖ</span>
                    <input type="date" class="date-input" id="attendanceDate" onchange="loadAttendance()">
                    <button class="btn btn-secondary" onclick="setToday()" style="width: auto; padding: 10px 15px;">Ïò§Îäò</button>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <span>‚úÖ</span>
                        <span id="attendanceTitle">Ï∂úÏÑù Ï≤¥ÌÅ¨</span>
                    </div>
                    
                    <div class="stats-row">
                        <div class="stat-box">
                            <div class="stat-number" id="statTotal">0</div>
                            <div class="stat-label">Ï†ÑÏ≤¥</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="statPresent" style="color: #16a34a;">0</div>
                            <div class="stat-label">Ï∂úÏÑù</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="statAbsent" style="color: #dc2626;">0</div>
                            <div class="stat-label">Í≤∞ÏÑù</div>
                        </div>
                    </div>
                    
                    <div id="memberList">
                        <!-- ÎèôÏ†Å ÏÉùÏÑ± -->
                    </div>
                </div>
                
                <div style="padding: 15px;">
                    <button class="btn btn-success" onclick="saveAttendance()">üíæ Ï∂úÏÑù Ï†ÄÏû•</button>
                </div>
            </div>
            
            <!-- ÌÉ≠ Ïª®ÌÖêÏ∏†: Î≥¥Í≥†ÏÑú -->
            <div id="tabReport" class="hidden">
                <div class="date-selector">
                    <span>üìÖ</span>
                    <input type="date" class="date-input" id="reportDate">
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <span>üìù</span>
                        <span>Íµ¨Ïó≠ÏòàÎ∞∞ Î≥¥Í≥†ÏÑú</span>
                    </div>
                    
                    <div class="report-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ÏòàÎ∞∞ Ïû•ÏÜå</label>
                                <input type="text" class="form-input" id="reportPlace" placeholder="Ïòà: ÍπÄÏ≤†Ïàò Ïßë">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÏòàÎ∞∞ ÏãúÍ∞Ñ</label>
                                <input type="time" class="form-input" id="reportTime" value="14:00">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ïù∏ÎèÑÏûê</label>
                            <input type="text" class="form-input" id="reportLeader" placeholder="Ïù∏ÎèÑÏûê Ïù¥Î¶Ñ">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ï∞¨Ïñë</label>
                            <input type="text" class="form-input" id="reportHymn" placeholder="Ïòà: Ï∞¨ÏÜ°Í∞Ä 94Ïû•">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ÏÑ±Í≤Ω Î≥∏Î¨∏</label>
                                <input type="text" class="form-input" id="reportScripture" placeholder="Ïòà: ÎßàÌÉúÎ≥µÏùå 5:1-12">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÎßêÏîÄ Ï†úÎ™©</label>
                                <input type="text" class="form-input" id="reportTitle" placeholder="ÎßêÏîÄ Ï†úÎ™©">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Íµ¨Ïó≠ ÌóåÍ∏à ($)</label>
                            <input type="number" class="form-input" id="reportOffering" placeholder="0" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Í∏∞ÎèÑÏ†úÎ™©</label>
                            <textarea class="form-textarea" id="reportPrayer" placeholder="Íµ¨Ïó≠ÏõêÎì§Ïùò Í∏∞ÎèÑÏ†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ÌäπÏù¥ÏÇ¨Ìï≠ / ÎÇòÎàî</label>
                            <textarea class="form-textarea" id="reportNotes" placeholder="ÏÉàÏã†Ïûê, Í∞êÏÇ¨, ÎÇòÎàî Îì±"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Ï∂úÏÑù/Í≤∞ÏÑù ÌòÑÌô© Ïπ¥Îìú -->
                <div class="card">
                    <div class="card-title">
                        <span>üìã</span>
                        <span>Ï∂úÏÑù/Í≤∞ÏÑù ÌòÑÌô©</span>
                        <button onclick="refreshReportAttendance()" style="margin-left: auto; background: #e2e8f0; border: none; padding: 5px 12px; border-radius: 15px; font-size: 0.8em; cursor: pointer;">ÏÉàÎ°úÍ≥†Ïπ®</button>
                    </div>
                    <div id="reportAttendanceStatus">
                        <div style="text-align: center; padding: 20px; color: #94a3b8;">
                            Ï∂úÏÑù Ï≤¥ÌÅ¨ ÌÉ≠ÏóêÏÑú Î®ºÏ†Ä Ï∂úÏÑùÏùÑ Ï≤¥ÌÅ¨Ìï¥Ï£ºÏÑ∏Ïöî
                        </div>
                    </div>
                </div>
                
                <div style="padding: 15px;">
                    <button class="btn btn-primary" onclick="submitReport()">üì§ Î≥¥Í≥†ÏÑú Ï†úÏ∂ú</button>
                </div>
            </div>
            
            <!-- ÌÉ≠ Ïª®ÌÖêÏ∏†: ÌòÑÌô© (Í¥ÄÎ¶¨ÏûêÏö©) -->
            <div id="tabOverview" class="hidden">
                <div class="overview-card">
                    <div class="overview-title" id="overviewDateTitle">12Ïõî 8Ïùº Íµ¨Ïó≠ÏòàÎ∞∞ ÌòÑÌô©</div>
                    <div class="overview-stats" style="grid-template-columns: repeat(5, 1fr);">
                        <div class="overview-stat">
                            <div class="overview-number" id="overviewSubmitted">0</div>
                            <div class="overview-label">Î≥¥Í≥†ÏÑú</div>
                        </div>
                        <div class="overview-stat">
                            <div class="overview-number" id="overviewTotal">0</div>
                            <div class="overview-label">Íµ¨Ïó≠</div>
                        </div>
                        <div class="overview-stat">
                            <div class="overview-number" id="overviewAttendance" style="color: #4ade80;">0</div>
                            <div class="overview-label">Ï∂úÏÑù</div>
                        </div>
                        <div class="overview-stat">
                            <div class="overview-number" id="overviewAbsent" style="color: #f87171;">0</div>
                            <div class="overview-label">Í≤∞ÏÑù</div>
                        </div>
                        <div class="overview-stat">
                            <div class="overview-number" id="overviewOffering">$0</div>
                            <div class="overview-label">ÌóåÍ∏à</div>
                        </div>
                    </div>
                </div>
                
                <div class="date-selector">
                    <span>üìÖ</span>
                    <input type="date" class="date-input" id="overviewDate" onchange="loadOverview()">
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <span>üìä</span>
                        <span>Íµ¨Ïó≠Î≥Ñ ÌòÑÌô©</span>
                    </div>
                    <div id="overviewList">
                        <!-- ÎèôÏ†Å ÏÉùÏÑ± -->
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <span>üôè</span>
                        <span>Í∏àÏ£º Í∏∞ÎèÑÏ†úÎ™©</span>
                    </div>
                    <div id="prayerList">
                        <!-- ÎèôÏ†Å ÏÉùÏÑ± -->
                    </div>
                </div>
            </div>
            
            <!-- ÌÉ≠ Ïª®ÌÖêÏ∏†: Í∏∞Î°ù -->
            <div id="tabHistory" class="hidden">
                <div class="card">
                    <div class="card-title">
                        <span>üìö</span>
                        <span>ÏßÄÎÇú Î≥¥Í≥†ÏÑú</span>
                    </div>
                    <div id="historyList">
                        <!-- ÎèôÏ†Å ÏÉùÏÑ± -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ÌïòÎã® ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
    <div class="tab-nav hidden" id="tabNav">
        <button class="tab-btn active" onclick="showTab('attendance')" id="tabBtnAttendance">
            <span class="tab-icon">‚úÖ</span>
            <span>Ï∂úÏÑù</span>
        </button>
        <button class="tab-btn" onclick="showTab('report')" id="tabBtnReport">
            <span class="tab-icon">üìù</span>
            <span>Î≥¥Í≥†ÏÑú</span>
        </button>
        <button class="tab-btn hidden" onclick="showTab('overview')" id="tabBtnOverview">
            <span class="tab-icon">üìä</span>
            <span>ÌòÑÌô©</span>
        </button>
        <button class="tab-btn" onclick="showTab('history')" id="tabBtnHistory">
            <span class="tab-icon">üìö</span>
            <span>Í∏∞Î°ù</span>
        </button>
    </div>
    
    <!-- Í≤∞ÏÑù ÏÇ¨Ïú† Î™®Îã¨ -->
    <div class="modal" id="reasonModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Í≤∞ÏÑù ÏÇ¨Ïú† ÏûÖÎ†•</h3>
                <button class="modal-close" onclick="closeReasonModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reasonMemberId">
                <div class="form-group">
                    <label class="form-label">Í≤∞ÏÑùÏûê: <strong id="reasonMemberName"></strong></label>
                </div>
                <div class="form-group">
                    <label class="form-label">Í≤∞ÏÑù ÏÇ¨Ïú†</label>
                    <select class="form-input" id="reasonSelect" onchange="onReasonSelect()">
                        <option value="">-- ÏÑ†ÌÉù --</option>
                        <option value="Ï∂úÏû•">Ï∂úÏû•</option>
                        <option value="Ïó¨Ìñâ">Ïó¨Ìñâ</option>
                        <option value="ÏïÑÌîî">ÏïÑÌîî/Î≥ëÏõê</option>
                        <option value="Í∞ÄÏ°±ÌñâÏÇ¨">Í∞ÄÏ°± ÌñâÏÇ¨</option>
                        <option value="ÏßÅÏû•">ÏßÅÏû• Í∑ºÎ¨¥</option>
                        <option value="Í∏∞ÌÉÄ">Í∏∞ÌÉÄ (ÏßÅÏ†ëÏûÖÎ†•)</option>
                    </select>
                </div>
                <div class="form-group" id="customReasonGroup" style="display: none;">
                    <label class="form-label">ÏÇ¨Ïú† ÏûÖÎ†•</label>
                    <input type="text" class="form-input" id="customReason" placeholder="Í≤∞ÏÑù ÏÇ¨Ïú†Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeReasonModal()" style="width: auto;">Ï∑®ÏÜå</button>
                <button class="btn btn-primary" onclick="saveReason()" style="width: auto;">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>
    
    <!-- Î≥¥Í≥†ÏÑú ÏÉÅÏÑ∏ Î™®Îã¨ -->
    <div class="modal" id="reportDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="reportDetailTitle">Î≥¥Í≥†ÏÑú ÏÉÅÏÑ∏</h3>
                <button class="modal-close" onclick="closeReportDetail()">√ó</button>
            </div>
            <div class="modal-body" id="reportDetailContent">
                <!-- ÎèôÏ†Å ÏÉùÏÑ± -->
            </div>
        </div>
    </div>
    
    <!-- ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ -->
    <div class="toast" id="toast"></div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase ÏÑ§Ï†ï (Î©îÏù∏ ÏãúÏä§ÌÖúÍ≥º ÎèôÏùº)
        const firebaseConfig = {
            apiKey: "AIzaSyDxGpjfG5Rfpc8M5-k_xhmt7eYHhwGeVVU",
            authDomain: "gkc-web-project-c87c9.firebaseapp.com",
            projectId: "gkc-web-project-c87c9",
            storageBucket: "gkc-web-project.firebasestorage.app",
            messagingSenderId: "842400243498",
            appId: "1:842400243498:web:2a79694db7a0343e4e3f4c"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentUser = null;
        let members = [];
        let cells = [];
        let cellAttendance = {};
        let cellReports = {};
        let absentReasons = {};
        let selectedCell = null;
        let attendanceData = {}; // ÌòÑÏû¨ ÎÇ†ÏßúÏùò Ï∂úÏÑù Îç∞Ïù¥ÌÑ∞
        
        // Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            // ÎÇ†Ïßú Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï (Ïù¥Î≤à Ï£ºÏùº)
            setToday();
            
            // Ï†ÄÏû•Îêú Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ ÌôïÏù∏
            const savedUser = localStorage.getItem('cellAppUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                initApp();
            }
        });
        
        // Ïù¥Î≤à Ï£ºÏùº ÎÇ†Ïßú ÏÑ§Ï†ï
        function setToday() {
            const today = new Date();
            const sunday = new Date(today);
            sunday.setDate(today.getDate() - today.getDay()); // Ïù¥Î≤à Ï£º ÏùºÏöîÏùº
            
            const dateStr = sunday.toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = dateStr;
            document.getElementById('reportDate').value = dateStr;
            document.getElementById('overviewDate').value = dateStr;
            
            loadAttendance();
        }
        
        // Î°úÍ∑∏Ïù∏
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showToast('ÏïÑÏù¥ÎîîÏôÄ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî');
                return;
            }
            
            try {
                // FirebaseÏóêÏÑú ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú
                const usersDoc = await db.collection('registeredUsers').doc('main').get();
                if (!usersDoc.exists) {
                    showToast('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§');
                    return;
                }
                
                const users = usersDoc.data().list || [];
                const user = users.find(u => u.username === username && u.password === password);
                
                if (!user) {
                    showToast('ÏïÑÏù¥Îîî ÎòêÎäî ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ¶ΩÎãàÎã§');
                    return;
                }
                
                // Í∂åÌïú ÌôïÏù∏ (Íµ¨Ïó≠Í¥ÄÎ¶¨ Í∂åÌïú ÎòêÎäî Í¥ÄÎ¶¨Ïûê)
                const hasAccess = user.role === 'Í¥ÄÎ¶¨Ïûê' || 
                                  (user.permissions && user.permissions.includes('cell'));
                
                if (!hasAccess) {
                    showToast('Íµ¨Ïó≠Í¥ÄÎ¶¨ Ï†ëÍ∑º Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§');
                    return;
                }
                
                currentUser = user;
                localStorage.setItem('cellAppUser', JSON.stringify(user));
                
                initApp();
                showToast('Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ!');
                
            } catch (error) {
                console.error('Î°úÍ∑∏Ïù∏ Ïò§Î•ò:', error);
                showToast('Î°úÍ∑∏Ïù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§');
            }
        }
        
        // Ïï± Ï¥àÍ∏∞Ìôî
        async function initApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('tabNav').classList.remove('hidden');
            document.getElementById('logoutBtn').style.display = 'block';
            
            // Í¥ÄÎ¶¨ÏûêÎ©¥ ÌòÑÌô© ÌÉ≠ ÌëúÏãú
            if (currentUser.role === 'Í¥ÄÎ¶¨Ïûê') {
                document.getElementById('tabBtnOverview').classList.remove('hidden');
            }
            
            // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            await loadData();
            
            // Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
            setupRealtimeListeners();
            
            // Íµ¨Ïó≠ ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
            initCellSelector();
            
            // Ï∂úÏÑù Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            loadAttendance();
        }
        
        // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadData() {
            try {
                // ÍµêÏù∏ Îç∞Ïù¥ÌÑ∞
                const membersDoc = await db.collection('churchMembers').doc('main').get();
                if (membersDoc.exists) {
                    members = membersDoc.data().list || [];
                }
                
                // Íµ¨Ïó≠ Îç∞Ïù¥ÌÑ∞
                const cellsDoc = await db.collection('churchCells').doc('main').get();
                if (cellsDoc.exists) {
                    cells = cellsDoc.data().list || [];
                }
                
                // Íµ¨Ïó≠ Ï∂úÏÑù Îç∞Ïù¥ÌÑ∞
                const attDoc = await db.collection('cellAttendance').doc('main').get();
                if (attDoc.exists) {
                    cellAttendance = attDoc.data().data || {};
                }
                
                // Íµ¨Ïó≠ Î≥¥Í≥†ÏÑú Îç∞Ïù¥ÌÑ∞
                const reportsDoc = await db.collection('cellReports').doc('main').get();
                if (reportsDoc.exists) {
                    cellReports = reportsDoc.data().data || {};
                }
                
                // Í≤∞ÏÑù ÏÇ¨Ïú†
                const reasonsDoc = await db.collection('absentReasons').doc('main').get();
                if (reasonsDoc.exists) {
                    absentReasons = reasonsDoc.data().data || {};
                }
                
            } catch (error) {
                console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
                showToast('Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§');
            }
        }
        
        // Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupRealtimeListeners() {
            console.log('üîÑ Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï Ï§ë...');
            
            // Íµ¨Ïó≠ Ï∂úÏÑù Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî
            db.collection('cellAttendance').doc('main').onSnapshot(doc => {
                if (doc.exists && doc.data().data) {
                    const newData = doc.data().data;
                    if (JSON.stringify(newData) !== JSON.stringify(cellAttendance)) {
                        console.log('üîÑ Íµ¨Ïó≠ Ï∂úÏÑù Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏');
                        cellAttendance = newData;
                        loadAttendance();
                    }
                }
            });
            
            // Íµ¨Ïó≠ Î≥¥Í≥†ÏÑú Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî
            db.collection('cellReports').doc('main').onSnapshot(doc => {
                if (doc.exists && doc.data().data) {
                    const newData = doc.data().data;
                    if (JSON.stringify(newData) !== JSON.stringify(cellReports)) {
                        console.log('üîÑ Íµ¨Ïó≠ Î≥¥Í≥†ÏÑú Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏');
                        cellReports = newData;
                        if (currentUser.role === 'Í¥ÄÎ¶¨Ïûê') {
                            loadOverview();
                        }
                        loadHistory();
                    }
                }
            });
            
            // Í≤∞ÏÑù ÏÇ¨Ïú† Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî
            db.collection('absentReasons').doc('main').onSnapshot(doc => {
                if (doc.exists && doc.data().data) {
                    const newData = doc.data().data;
                    if (JSON.stringify(newData) !== JSON.stringify(absentReasons)) {
                        console.log('üîÑ Í≤∞ÏÑù ÏÇ¨Ïú† Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏');
                        absentReasons = newData;
                        loadAttendance();
                    }
                }
            });
            
            // ÍµêÏù∏ Îç∞Ïù¥ÌÑ∞ Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî
            db.collection('churchMembers').doc('main').onSnapshot(doc => {
                if (doc.exists && doc.data().list) {
                    const newData = doc.data().list;
                    if (JSON.stringify(newData) !== JSON.stringify(members)) {
                        console.log('üîÑ ÍµêÏù∏ Îç∞Ïù¥ÌÑ∞ Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏:', newData.length + 'Î™Ö');
                        members = newData;
                        loadAttendance();
                    }
                }
            });
            
            // Íµ¨Ïó≠ Îç∞Ïù¥ÌÑ∞ Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî
            db.collection('churchCells').doc('main').onSnapshot(doc => {
                if (doc.exists && doc.data().list) {
                    const newData = doc.data().list;
                    if (JSON.stringify(newData) !== JSON.stringify(cells)) {
                        console.log('üîÑ Íµ¨Ïó≠ Îç∞Ïù¥ÌÑ∞ Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏:', newData.length + 'Í∞ú');
                        cells = newData;
                        initCellSelector();
                    }
                }
            });
            
            console.log('‚úÖ Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï ÏôÑÎ£å!');
            showToast('üîÑ Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî ÌôúÏÑ±ÌôîÎê®');
        }
        
        // Íµ¨Ïó≠ ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
        function initCellSelector() {
            const select = document.getElementById('cellSelect');
            select.innerHTML = '';
            
            // Í¥ÄÎ¶¨ÏûêÎäî Î™®Îì† Íµ¨Ïó≠, Íµ¨Ïó≠Ïû•ÏùÄ ÏûêÍ∏∞ Íµ¨Ïó≠Îßå
            let availableCells = [];
            
            if (currentUser.role === 'Í¥ÄÎ¶¨Ïûê') {
                availableCells = cells;
            } else {
                // Íµ¨Ïó≠Ïû•Ïù∏ Íµ¨Ïó≠ Ï∞æÍ∏∞
                availableCells = cells.filter(c => c.leaderName === currentUser.name);
                
                // Íµ¨Ïó≠Ïû•Ïù¥ ÏïÑÎãàÎ©¥ ÏÜåÏÜç Íµ¨Ïó≠
                if (availableCells.length === 0) {
                    const member = members.find(m => m.nameKr === currentUser.name);
                    if (member && member.cell) {
                        const cellName = member.cell.replace('Íµ¨Ïó≠', '');
                        const cell = cells.find(c => c.name === cellName || c.name === member.cell);
                        if (cell) availableCells = [cell];
                    }
                }
            }
            
            if (availableCells.length === 0) {
                select.innerHTML = '<option value="">Ï†ëÍ∑º Í∞ÄÎä•Ìïú Íµ¨Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§</option>';
                return;
            }
            
            availableCells.forEach((cell, idx) => {
                const option = document.createElement('option');
                option.value = cell.name;
                option.textContent = `${cell.name}Íµ¨Ïó≠ (Íµ¨Ïó≠Ïû•: ${cell.leaderName || 'ÎØ∏ÏßÄÏ†ï'})`;
                select.appendChild(option);
            });
            
            selectedCell = availableCells[0].name;
            
            // Íµ¨Ïó≠Ïù¥ 1Í∞úÎ©¥ ÏÖÄÎ†âÌÑ∞ Ïà®ÍπÄ
            if (availableCells.length === 1 && currentUser.role !== 'Í¥ÄÎ¶¨Ïûê') {
                document.getElementById('cellSelector').style.display = 'none';
            }
            
            loadAttendance();
        }
        
        // Íµ¨Ïó≠ Î≥ÄÍ≤Ω
        function onCellChange() {
            selectedCell = document.getElementById('cellSelect').value;
            loadAttendance();
        }
        
        // Ï∂úÏÑù Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        function loadAttendance() {
            if (!selectedCell) return;
            
            const dateStr = document.getElementById('attendanceDate').value;
            const cell = cells.find(c => c.name === selectedCell);
            
            if (!cell) return;
            
            // Ìï¥Îãπ Íµ¨Ïó≠ Íµ¨Ïó≠Ïõê Î™©Î°ù
            const cellMembers = members.filter(m => {
                const memberCell = (m.cell || '').replace('Íµ¨Ïó≠', '');
                return memberCell === selectedCell || m.cell === selectedCell + 'Íµ¨Ïó≠';
            });
            
            // Íµ¨Ïó≠Ïû• Ï∂îÍ∞Ä
            if (cell.leaderName) {
                const leader = members.find(m => m.nameKr === cell.leaderName);
                if (leader && !cellMembers.find(m => m.nameKr === cell.leaderName)) {
                    cellMembers.unshift(leader);
                }
            }
            
            // Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('attendanceTitle').textContent = `${selectedCell}Íµ¨Ïó≠ Ï∂úÏÑùÏ≤¥ÌÅ¨`;
            
            // Ìï¥Îãπ ÎÇ†ÏßúÏùò Ï∂úÏÑù Îç∞Ïù¥ÌÑ∞
            const key = `${selectedCell}_${dateStr}`;
            const savedAttendance = cellAttendance[key] || [];
            
            // Ï∂úÏÑù Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
            attendanceData = {};
            cellMembers.forEach(m => {
                attendanceData[m.nameKr] = savedAttendance.includes(m.nameKr);
            });
            
            // Î™©Î°ù Î†åÎçîÎßÅ
            const container = document.getElementById('memberList');
            
            if (cellMembers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üë•</div>
                        <div>Íµ¨Ïó≠ÏõêÏù¥ ÏóÜÏäµÎãàÎã§</div>
                    </div>
                `;
                updateStats();
                return;
            }
            
            let html = '';
            cellMembers.forEach((m, idx) => {
                const isPresent = attendanceData[m.nameKr];
                const isLeader = m.nameKr === cell.leaderName;
                const reasonKey = `${selectedCell}_${dateStr}_${m.nameKr}`;
                const reason = absentReasons[reasonKey] || '';
                
                html += `
                    <div class="member-item">
                        <input type="checkbox" class="member-checkbox" 
                               ${isPresent ? 'checked' : ''} 
                               onchange="toggleAttendance('${m.nameKr}', this.checked)">
                        <div class="member-info">
                            <div class="member-name">
                                ${m.nameKr}
                                ${isLeader ? '<span style="color: #4f46e5; font-size: 0.8em;">(Íµ¨Ïó≠Ïû•)</span>' : ''}
                                <a href="tel:${m.phone}" class="phone-link" style="color: #64748b; font-size: 0.85em; margin-left: 8px;">${m.phone || ''}</a>
                            </div>
                        </div>
                        ${isPresent ? 
                            '<span class="member-status status-present">Ï∂úÏÑù</span>' :
                            `<button class="reason-btn" onclick="openReasonModal('${m.nameKr}')">${reason || 'ÏÇ¨Ïú†ÏûÖÎ†•'}</button>`
                        }
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateStats();
        }
        
        // Ï∂úÏÑù ÌÜ†Í∏Ä - Ï¶âÏãú Ï†ÄÏû•
        async function toggleAttendance(name, checked) {
            attendanceData[name] = checked;
            
            // Ï¶âÏãú FirebaseÏôÄ localStorageÏóê Ï†ÄÏû•
            const dateStr = document.getElementById('attendanceDate').value;
            const key = `${selectedCell}_${dateStr}`;
            
            // Ï∂úÏÑùÏûê Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
            const presentList = Object.keys(attendanceData).filter(n => attendanceData[n]);
            cellAttendance[key] = presentList;
            
            // localStorageÏóê Ï†ÄÏû• (Î©îÏù∏ ÏÇ¨Ïù¥Ìä∏ÏôÄ ÎèôÍ∏∞Ìôî)
            localStorage.setItem('cellAttendance', JSON.stringify(cellAttendance));
            
            try {
                // FirebaseÏóê Ï†ÄÏû•
                await db.collection('cellAttendance').doc('main').set({ data: cellAttendance });
                console.log('‚úÖ Ï∂úÏÑù Ï†ÄÏû•:', name, checked ? 'Ï∂úÏÑù' : 'Í≤∞ÏÑù');
            } catch (error) {
                console.error('Ï†ÄÏû• Ïò§Î•ò:', error);
            }
            
            loadAttendance(); // Îã§Ïãú Î†åÎçîÎßÅ
        }
        
        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStats() {
            const total = Object.keys(attendanceData).length;
            const present = Object.values(attendanceData).filter(v => v).length;
            const absent = total - present;
            
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statPresent').textContent = present;
            document.getElementById('statAbsent').textContent = absent;
        }
        
        // Í≤∞ÏÑù ÏÇ¨Ïú† Î™®Îã¨ Ïó¥Í∏∞
        function openReasonModal(name) {
            const dateStr = document.getElementById('attendanceDate').value;
            const reasonKey = `${selectedCell}_${dateStr}_${name}`;
            const savedReason = absentReasons[reasonKey] || '';
            
            document.getElementById('reasonMemberId').value = name;
            document.getElementById('reasonMemberName').textContent = name;
            document.getElementById('reasonSelect').value = '';
            document.getElementById('customReason').value = '';
            document.getElementById('customReasonGroup').style.display = 'none';
            
            // Í∏∞Ï°¥ ÏÇ¨Ïú†Í∞Ä ÏûàÏúºÎ©¥ ÏÑ§Ï†ï
            if (savedReason) {
                const options = ['Ï∂úÏû•', 'Ïó¨Ìñâ', 'ÏïÑÌîî', 'Í∞ÄÏ°±ÌñâÏÇ¨', 'ÏßÅÏû•'];
                if (options.includes(savedReason)) {
                    document.getElementById('reasonSelect').value = savedReason;
                } else {
                    document.getElementById('reasonSelect').value = 'Í∏∞ÌÉÄ';
                    document.getElementById('customReason').value = savedReason;
                    document.getElementById('customReasonGroup').style.display = 'block';
                }
            }
            
            document.getElementById('reasonModal').classList.add('active');
        }
        
        // Í≤∞ÏÑù ÏÇ¨Ïú† ÏÑ†ÌÉù
        function onReasonSelect() {
            const value = document.getElementById('reasonSelect').value;
            document.getElementById('customReasonGroup').style.display = value === 'Í∏∞ÌÉÄ' ? 'block' : 'none';
        }
        
        // Í≤∞ÏÑù ÏÇ¨Ïú† Ï†ÄÏû•
        function saveReason() {
            const name = document.getElementById('reasonMemberId').value;
            const dateStr = document.getElementById('attendanceDate').value;
            let reason = document.getElementById('reasonSelect').value;
            
            if (reason === 'Í∏∞ÌÉÄ') {
                reason = document.getElementById('customReason').value.trim();
            }
            
            const reasonKey = `${selectedCell}_${dateStr}_${name}`;
            absentReasons[reasonKey] = reason;
            
            closeReasonModal();
            loadAttendance();
            showToast('Í≤∞ÏÑù ÏÇ¨Ïú†Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§');
        }
        
        // Î™®Îã¨ Îã´Í∏∞
        function closeReasonModal() {
            document.getElementById('reasonModal').classList.remove('active');
        }
        
        // Ï∂úÏÑù Ï†ÄÏû•
        async function saveAttendance() {
            if (!selectedCell) return;
            
            const dateStr = document.getElementById('attendanceDate').value;
            const key = `${selectedCell}_${dateStr}`;
            
            // Ï∂úÏÑùÏûê Î™©Î°ù
            const presentList = Object.keys(attendanceData).filter(name => attendanceData[name]);
            cellAttendance[key] = presentList;
            
            try {
                // FirebaseÏóê Ï†ÄÏû•
                await db.collection('cellAttendance').doc('main').set({ data: cellAttendance });
                await db.collection('absentReasons').doc('main').set({ data: absentReasons });
                
                showToast('‚úÖ Ï∂úÏÑùÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
            } catch (error) {
                console.error('Ï†ÄÏû• Ïò§Î•ò:', error);
                showToast('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§');
            }
        }
        
        // Î≥¥Í≥†ÏÑú Ï∂úÏÑùÌòÑÌô© ÏÉàÎ°úÍ≥†Ïπ®
        function refreshReportAttendance() {
            if (!selectedCell) {
                document.getElementById('reportAttendanceStatus').innerHTML = '<div style="text-align: center; padding: 20px; color: #94a3b8;">Íµ¨Ïó≠ÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</div>';
                return;
            }
            
            const dateStr = document.getElementById('reportDate').value;
            const key = `${selectedCell}_${dateStr}`;
            const presentList = cellAttendance[key] || [];
            
            // Íµ¨Ïó≠Ïõê Ï†ÑÏ≤¥ Î™©Î°ù
            const cell = cells.find(c => c.name === selectedCell);
            if (!cell) return;
            
            const cellMembers = members.filter(m => {
                const memberCell = (m.cell || '').replace('Íµ¨Ïó≠', '');
                return memberCell === selectedCell || m.cell === selectedCell + 'Íµ¨Ïó≠';
            });
            
            // Íµ¨Ïó≠Ïû• Ìè¨Ìï®
            const allMembers = [];
            if (cell.leaderName) {
                allMembers.push({ nameKr: cell.leaderName, isLeader: true });
            }
            cellMembers.forEach(m => {
                if (m.nameKr !== cell.leaderName) {
                    allMembers.push({ nameKr: m.nameKr, isLeader: false });
                }
            });
            
            const absentList = allMembers.filter(m => !presentList.includes(m.nameKr));
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div style="background: #dcfce7; border-radius: 12px; padding: 15px;">
                        <div style="font-weight: 600; color: #16a34a; margin-bottom: 10px;">‚úÖ Ï∂úÏÑù (${presentList.length}Î™Ö)</div>
                        ${presentList.length > 0 ? presentList.map(name => {
                            const member = allMembers.find(m => m.nameKr === name);
                            const isLeader = member?.isLeader || name === cell.leaderName;
                            return `<div style="font-size: 0.9em; padding: 3px 0; color: #166534;">${name}${isLeader ? ' (Íµ¨Ïó≠Ïû•)' : ''}</div>`;
                        }).join('') : '<div style="font-size: 0.85em; color: #94a3b8;">ÏóÜÏùå</div>'}
                    </div>
                    <div style="background: #fee2e2; border-radius: 12px; padding: 15px;">
                        <div style="font-weight: 600; color: #dc2626; margin-bottom: 10px;">‚ùå Í≤∞ÏÑù (${absentList.length}Î™Ö)</div>
                        ${absentList.length > 0 ? absentList.map(m => {
                            const reasonKey = `${selectedCell}_${dateStr}_${m.nameKr}`;
                            const reason = absentReasons[reasonKey] || '';
                            return `<div style="font-size: 0.9em; padding: 3px 0; color: #991b1b;">
                                ${m.nameKr}${m.isLeader ? ' (Íµ¨Ïó≠Ïû•)' : ''}
                                ${reason ? `<span style="font-size: 0.8em; color: #dc2626;"> - ${reason}</span>` : ''}
                            </div>`;
                        }).join('') : '<div style="font-size: 0.85em; color: #94a3b8;">ÏóÜÏùå</div>'}
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px; padding: 10px; background: #f1f5f9; border-radius: 10px;">
                    <span style="font-weight: 600;">Ï∂úÏÑùÎ•†: </span>
                    <span style="color: ${(presentList.length / allMembers.length * 100) >= 70 ? '#16a34a' : '#dc2626'}; font-weight: 700;">
                        ${allMembers.length > 0 ? Math.round(presentList.length / allMembers.length * 100) : 0}%
                    </span>
                    <span style="color: #64748b; font-size: 0.9em;"> (${presentList.length}/${allMembers.length}Î™Ö)</span>
                </div>
            `;
            
            document.getElementById('reportAttendanceStatus').innerHTML = html;
        }
        
        // Î≥¥Í≥†ÏÑú Ï†úÏ∂ú
        async function submitReport() {
            if (!selectedCell) return;
            
            const dateStr = document.getElementById('reportDate').value;
            const key = `${selectedCell}_${dateStr}`;
            
            // Íµ¨Ïó≠Ïõê Ï†ÑÏ≤¥ Î™©Î°ù
            const cell = cells.find(c => c.name === selectedCell);
            const cellMembers = members.filter(m => {
                const memberCell = (m.cell || '').replace('Íµ¨Ïó≠', '');
                return memberCell === selectedCell || m.cell === selectedCell + 'Íµ¨Ïó≠';
            });
            
            const allMembers = [];
            if (cell && cell.leaderName) {
                allMembers.push(cell.leaderName);
            }
            cellMembers.forEach(m => {
                if (m.nameKr && m.nameKr !== cell?.leaderName) {
                    allMembers.push(m.nameKr);
                }
            });
            
            const presentList = cellAttendance[key] || [];
            const absentList = allMembers.filter(name => !presentList.includes(name));
            
            // Í≤∞ÏÑù ÏÇ¨Ïú†
            const absentWithReasons = absentList.map(name => {
                const reasonKey = `${selectedCell}_${dateStr}_${name}`;
                return {
                    name: name,
                    reason: absentReasons[reasonKey] || ''
                };
            });
            
            const report = {
                cell: selectedCell,
                date: dateStr,
                place: document.getElementById('reportPlace').value,
                time: document.getElementById('reportTime').value,
                leader: document.getElementById('reportLeader').value,
                hymn: document.getElementById('reportHymn').value,
                scripture: document.getElementById('reportScripture').value,
                title: document.getElementById('reportTitle').value,
                offering: parseInt(document.getElementById('reportOffering').value) || 0,
                prayer: document.getElementById('reportPrayer').value,
                notes: document.getElementById('reportNotes').value,
                attendance: presentList,
                absent: absentWithReasons,
                totalMembers: allMembers.length,
                attendanceRate: allMembers.length > 0 ? Math.round(presentList.length / allMembers.length * 100) : 0,
                submittedAt: new Date().toISOString(),
                submittedBy: currentUser.name
            };
            
            // ÌïÑÏàò Ìï≠Î™© ÌôïÏù∏
            if (!report.place || !report.leader) {
                showToast('ÏòàÎ∞∞ Ïû•ÏÜåÏôÄ Ïù∏ÎèÑÏûêÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                return;
            }
            
            cellReports[key] = report;
            
            try {
                await db.collection('cellReports').doc('main').set({ data: cellReports });
                showToast('üì§ Î≥¥Í≥†ÏÑúÍ∞Ä Ï†úÏ∂úÎêòÏóàÏäµÎãàÎã§!');
                
                // Ìèº Ï¥àÍ∏∞Ìôî
                document.getElementById('reportPlace').value = '';
                document.getElementById('reportLeader').value = '';
                document.getElementById('reportHymn').value = '';
                document.getElementById('reportScripture').value = '';
                document.getElementById('reportTitle').value = '';
                document.getElementById('reportOffering').value = '';
                document.getElementById('reportPrayer').value = '';
                document.getElementById('reportNotes').value = '';
                
            } catch (error) {
                console.error('Ï†úÏ∂ú Ïò§Î•ò:', error);
                showToast('Ï†úÏ∂ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§');
            }
        }
        
        // ÌòÑÌô© Î°úÎìú (Í¥ÄÎ¶¨ÏûêÏö©)
        async function loadOverview() {
            const dateStr = document.getElementById('overviewDate').value;
            const date = new Date(dateStr);
            const dateLabel = `${date.getMonth() + 1}Ïõî ${date.getDate()}Ïùº`;
            
            document.getElementById('overviewDateTitle').textContent = `${dateLabel} Íµ¨Ïó≠ÏòàÎ∞∞ ÌòÑÌô©`;
            
            // ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
            let submitted = 0;
            let totalAttendance = 0;
            let totalAbsent = 0;
            let totalOffering = 0;
            let prayers = [];
            
            let listHtml = '';
            
            cells.forEach(cell => {
                const key = `${cell.name}_${dateStr}`;
                const report = cellReports[key];
                const attendance = cellAttendance[key] || [];
                
                const cellMembers = members.filter(m => {
                    const memberCell = (m.cell || '').replace('Íµ¨Ïó≠', '');
                    return memberCell === cell.name || m.cell === cell.name + 'Íµ¨Ïó≠';
                });
                
                const totalMembers = cellMembers.length + (cell.leaderName ? 1 : 0);
                const absentCount = totalMembers - attendance.length;
                const attendanceRate = totalMembers > 0 ? Math.round((attendance.length / totalMembers) * 100) : 0;
                
                if (report) {
                    submitted++;
                    totalAbsent += absentCount;
                    totalOffering += report.offering || 0;
                    if (report.prayer) {
                        prayers.push({ cell: cell.name, prayer: report.prayer });
                    }
                }
                
                totalAttendance += attendance.length;
                
                listHtml += `
                    <div class="report-item">
                        <div class="report-cell">${cell.name}Íµ¨Ïó≠</div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.85em; color: #64748b;">
                                <span style="color: #16a34a;">Ï∂úÏÑù ${attendance.length}Î™Ö</span> / 
                                <span style="color: #dc2626;">Í≤∞ÏÑù ${absentCount}Î™Ö</span>
                                <span style="margin-left: 5px;">(${attendanceRate}%)</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${attendanceRate}%"></div>
                            </div>
                        </div>
                        <span class="report-status ${report ? 'report-submitted' : 'report-pending'}">
                            ${report ? '‚úÖ Ï†úÏ∂ú' : '‚è≥ ÎØ∏Ï†úÏ∂ú'}
                        </span>
                        ${report ? `<button class="report-view-btn" onclick="viewReport('${cell.name}', '${dateStr}')">Î≥¥Í∏∞</button>` : ''}
                    </div>
                `;
            });
            
            document.getElementById('overviewSubmitted').textContent = submitted;
            document.getElementById('overviewTotal').textContent = cells.length;
            document.getElementById('overviewAttendance').textContent = totalAttendance;
            document.getElementById('overviewAbsent').textContent = totalAbsent;
            document.getElementById('overviewOffering').textContent = '$' + totalOffering;
            
            document.getElementById('overviewList').innerHTML = listHtml || '<div class="empty-state">Íµ¨Ïó≠ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div>';
            
            // Í∏∞ÎèÑÏ†úÎ™© Î™©Î°ù
            let prayerHtml = '';
            prayers.forEach(p => {
                prayerHtml += `
                    <div class="prayer-item">
                        <div class="prayer-name">${p.cell}Íµ¨Ïó≠</div>
                        <div class="prayer-content">${p.prayer}</div>
                    </div>
                `;
            });
            document.getElementById('prayerList').innerHTML = prayerHtml || '<div class="empty-state">Í∏∞ÎèÑÏ†úÎ™©Ïù¥ ÏóÜÏäµÎãàÎã§</div>';
        }
        
        // Î≥¥Í≥†ÏÑú ÏÉÅÏÑ∏ Î≥¥Í∏∞
        function viewReport(cellName, dateStr) {
            const key = `${cellName}_${dateStr}`;
            const report = cellReports[key];
            
            if (!report) return;
            
            const date = new Date(dateStr);
            const dateLabel = `${date.getMonth() + 1}Ïõî ${date.getDate()}Ïùº`;
            
            // Ï∂úÏÑù/Í≤∞ÏÑù Ï†ïÎ≥¥
            const presentList = report.attendance || [];
            const absentList = report.absent || [];
            const totalMembers = report.totalMembers || (presentList.length + absentList.length);
            const attendanceRate = report.attendanceRate || (totalMembers > 0 ? Math.round(presentList.length / totalMembers * 100) : 0);
            
            document.getElementById('reportDetailTitle').textContent = `${cellName}Íµ¨Ïó≠ Î≥¥Í≥†ÏÑú (${dateLabel})`;
            
            document.getElementById('reportDetailContent').innerHTML = `
                <div style="display: grid; gap: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div><strong>ÏòàÎ∞∞ Ïû•ÏÜå:</strong> ${report.place || '-'}</div>
                        <div><strong>ÏòàÎ∞∞ ÏãúÍ∞Ñ:</strong> ${report.time || '-'}</div>
                    </div>
                    <div><strong>Ïù∏ÎèÑÏûê:</strong> ${report.leader || '-'}</div>
                    <div><strong>Ï∞¨Ïñë:</strong> ${report.hymn || '-'}</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div><strong>Î≥∏Î¨∏:</strong> ${report.scripture || '-'}</div>
                        <div><strong>Ï†úÎ™©:</strong> ${report.title || '-'}</div>
                    </div>
                    
                    <!-- Ï∂úÏÑùÎ•† ÌëúÏãú -->
                    <div style="background: #f1f5f9; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: 700; color: ${attendanceRate >= 70 ? '#16a34a' : '#dc2626'};">
                            Ï∂úÏÑùÎ•† ${attendanceRate}%
                        </div>
                        <div style="color: #64748b; margin-top: 5px;">${presentList.length}Î™Ö Ï∂úÏÑù / ${absentList.length}Î™Ö Í≤∞ÏÑù (Ï†ÑÏ≤¥ ${totalMembers}Î™Ö)</div>
                    </div>
                    
                    <!-- Ï∂úÏÑù/Í≤∞ÏÑù ÌòÑÌô© -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="background: #dcfce7; padding: 15px; border-radius: 10px;">
                            <div style="font-weight: 600; color: #16a34a; margin-bottom: 10px;">‚úÖ Ï∂úÏÑù (${presentList.length}Î™Ö)</div>
                            ${presentList.length > 0 ? presentList.map(name => 
                                `<div style="font-size: 0.9em; color: #166534; padding: 2px 0;">${name}</div>`
                            ).join('') : '<div style="color: #94a3b8; font-size: 0.85em;">ÏóÜÏùå</div>'}
                        </div>
                        <div style="background: #fee2e2; padding: 15px; border-radius: 10px;">
                            <div style="font-weight: 600; color: #dc2626; margin-bottom: 10px;">‚ùå Í≤∞ÏÑù (${absentList.length}Î™Ö)</div>
                            ${absentList.length > 0 ? absentList.map(item => {
                                const name = typeof item === 'string' ? item : item.name;
                                const reason = typeof item === 'object' ? item.reason : '';
                                return `<div style="font-size: 0.9em; color: #991b1b; padding: 2px 0;">
                                    ${name}${reason ? ` <span style="font-size: 0.8em; color: #b91c1c;">(${reason})</span>` : ''}
                                </div>`;
                            }).join('') : '<div style="color: #94a3b8; font-size: 0.85em;">ÏóÜÏùå</div>'}
                        </div>
                    </div>
                    
                    <div><strong>Íµ¨Ïó≠ÌóåÍ∏à:</strong> $${report.offering || 0}</div>
                    <div style="background: #fef3c7; padding: 15px; border-radius: 10px;">
                        <strong>üôè Í∏∞ÎèÑÏ†úÎ™©</strong>
                        <div style="margin-top: 10px; white-space: pre-wrap;">${report.prayer || '-'}</div>
                    </div>
                    <div style="background: #f1f5f9; padding: 15px; border-radius: 10px;">
                        <strong>üìù ÌäπÏù¥ÏÇ¨Ìï≠</strong>
                        <div style="margin-top: 10px; white-space: pre-wrap;">${report.notes || '-'}</div>
                    </div>
                    <div style="font-size: 0.8em; color: #94a3b8; text-align: right;">
                        Ï†úÏ∂ú: ${report.submittedBy || '-'} (${new Date(report.submittedAt).toLocaleString('ko-KR')})
                    </div>
                </div>
            `;
            
            document.getElementById('reportDetailModal').classList.add('active');
        }
        
        function closeReportDetail() {
            document.getElementById('reportDetailModal').classList.remove('active');
        }
        
        // Í∏∞Î°ù Î°úÎìú
        function loadHistory() {
            const container = document.getElementById('historyList');
            
            // ÌòÑÏû¨ Íµ¨Ïó≠Ïùò Î≥¥Í≥†ÏÑúÎßå (ÎòêÎäî Í¥ÄÎ¶¨ÏûêÎ©¥ Ï†ÑÏ≤¥)
            let reports = [];
            
            Object.keys(cellReports).forEach(key => {
                const report = cellReports[key];
                if (currentUser.role === 'Í¥ÄÎ¶¨Ïûê' || report.cell === selectedCell) {
                    reports.push({ key, ...report });
                }
            });
            
            // ÎÇ†ÏßúÏàú Ï†ïÎ†¨ (ÏµúÏã†Ïàú)
            reports.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (reports.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìö</div><div>ÏûëÏÑ±Ìïú Î≥¥Í≥†ÏÑúÍ∞Ä ÏóÜÏäµÎãàÎã§</div></div>';
                return;
            }
            
            let html = '';
            reports.slice(0, 20).forEach(report => {
                const date = new Date(report.date);
                const dateLabel = `${date.getMonth() + 1}Ïõî ${date.getDate()}Ïùº`;
                
                html += `
                    <div class="report-item" onclick="viewReport('${report.cell}', '${report.date}')">
                        <div class="report-cell">${report.cell}Íµ¨Ïó≠</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${dateLabel}</div>
                            <div style="font-size: 0.8em; color: #64748b;">Ï∞∏ÏÑù ${report.attendance?.length || 0}Î™Ö | ÌóåÍ∏à $${report.offering || 0}</div>
                        </div>
                        <span style="color: #4f46e5;">‚Üí</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ÌÉ≠ Ï†ÑÌôò
        function showTab(tab) {
            // ÌÉ≠ Ïª®ÌÖêÏ∏†
            document.getElementById('tabAttendance').classList.add('hidden');
            document.getElementById('tabReport').classList.add('hidden');
            document.getElementById('tabOverview').classList.add('hidden');
            document.getElementById('tabHistory').classList.add('hidden');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');
            
            // ÌÉ≠ Î≤ÑÌäº
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tabBtn' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            
            // ÌÉ≠Î≥Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            if (tab === 'overview') {
                loadOverview();
            } else if (tab === 'history') {
                loadHistory();
            } else if (tab === 'report') {
                // Î≥¥Í≥†ÏÑú ÌÉ≠ Ï†ÑÌôò Ïãú Ï∂úÏÑù ÌòÑÌô© ÏÉàÎ°úÍ≥†Ïπ®
                setTimeout(() => refreshReportAttendance(), 100);
            }
        }
        
        // Î°úÍ∑∏ÏïÑÏõÉ
        function logout() {
            localStorage.removeItem('cellAppUser');
            currentUser = null;
            
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('tabNav').classList.add('hidden');
            document.getElementById('logoutBtn').style.display = 'none';
            
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            
            showToast('Î°úÍ∑∏ÏïÑÏõÉÎêòÏóàÏäµÎãàÎã§');
        }
        
        // ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // ===== ÏÑúÎπÑÏä§ÏõåÏª§ Îì±Î°ù =====
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker-cell.js')
                .then(reg => {
                    console.log('[Cell App] ÏÑúÎπÑÏä§ÏõåÏª§ Îì±Î°ù ÏôÑÎ£å');
                    
                    // ÏóÖÎç∞Ïù¥Ìä∏ Ï≤¥ÌÅ¨
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('[Cell App] ÏÉà Î≤ÑÏ†Ñ Î∞úÍ≤¨, ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë...');
                                showToast('üîÑ Ïï± ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë...');
                                newWorker.postMessage('skipWaiting');
                            }
                        });
                    });
                })
                .catch(err => console.error('[Cell App] ÏÑúÎπÑÏä§ÏõåÏª§ Îì±Î°ù Ïã§Ìå®:', err));
            
            // ÏÉà ÏÑúÎπÑÏä§ÏõåÏª§ ÌôúÏÑ±Ìôî Ïãú ÏÉàÎ°úÍ≥†Ïπ®
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('[Cell App] ÏÉà Î≤ÑÏ†Ñ Ï†ÅÏö©, ÏÉàÎ°úÍ≥†Ïπ®');
                window.location.reload();
            });
            
            // 1Î∂ÑÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏ Ï≤¥ÌÅ¨
            setInterval(() => {
                navigator.serviceWorker.getRegistration().then(reg => {
                    if (reg) reg.update();
                });
            }, 60000);
        }
        
        // ===== ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉú ÌëúÏãú =====
        function updateOnlineStatus() {
            if (navigator.onLine) {
                document.body.classList.remove('offline');
                console.log('[Cell App] Ïò®ÎùºÏù∏ ÏÉÅÌÉú');
            } else {
                document.body.classList.add('offline');
                showToast('üì¥ Ïò§ÌîÑÎùºÏù∏ Î™®Îìú - Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Î°ú ÏûëÎèô Ï§ë');
                console.log('[Cell App] Ïò§ÌîÑÎùºÏù∏ ÏÉÅÌÉú');
            }
        }
        
        window.addEventListener('online', () => {
            updateOnlineStatus();
            showToast('‚úÖ Ïò®ÎùºÏù∏ Î≥µÍ∑Ä - Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî Ï§ë...');
            // Ïò®ÎùºÏù∏ Î≥µÍ∑Ä Ïãú Îç∞Ïù¥ÌÑ∞ Îã§Ïãú Î°úÎìú
            if (currentUser) {
                loadData().then(() => {
                    loadAttendance();
                    showToast('‚úÖ ÎèôÍ∏∞Ìôî ÏôÑÎ£å!');
                });
            }
        });
        
        window.addEventListener('offline', updateOnlineStatus);
        
        // Ï¥àÍ∏∞ ÏÉÅÌÉú Ï≤¥ÌÅ¨
        updateOnlineStatus();
    </script>
</body>
</html>
