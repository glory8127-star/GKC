<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <title>GKC êµ¬ì—­ê´€ë¦¬</title>
    <link rel="manifest" href="manifest-cell.json">
    <link rel="apple-touch-icon" href="https://sacglory.church/icon-192.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif; background: #f5f7fa; min-height: 100vh; color: #333; }
        .header { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; padding: 15px 20px; position: fixed; top: 0; left: 0; right: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header h1 { font-size: 1.2em; font-weight: 600; }
        .header-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.85em; cursor: pointer; }
        .main-content { padding-top: 70px; padding-bottom: 80px; min-height: 100vh; }
        .login-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: calc(100vh - 70px); padding: 20px; }
        .login-box { background: white; border-radius: 20px; padding: 40px 30px; width: 100%; max-width: 350px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); text-align: center; }
        .login-logo { font-size: 3em; margin-bottom: 10px; }
        .login-title { font-size: 1.5em; color: #4f46e5; margin-bottom: 30px; font-weight: 700; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-label { display: block; font-size: 0.85em; color: #666; margin-bottom: 8px; font-weight: 500; }
        .form-input { width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1em; transition: all 0.3s; }
        .form-input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .btn { padding: 14px 30px; border: none; border-radius: 12px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s; width: 100%; }
        .btn-primary { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(79, 70, 229, 0.4); }
        .btn-secondary { background: #f1f5f9; color: #475569; }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .tab-nav { display: flex; background: white; padding: 10px; gap: 10px; position: fixed; bottom: 0; left: 0; right: 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: #f1f5f9; border-radius: 12px; font-size: 0.85em; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; color: #64748b; transition: all 0.3s; }
        .tab-btn.active { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; }
        .tab-icon { font-size: 1.3em; }
        .card { background: white; border-radius: 16px; padding: 15px; margin: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
        .card-title { font-size: 1.1em; font-weight: 600; color: #1e293b; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .cell-selector { padding: 15px; background: white; border-bottom: 1px solid #e2e8f0; }
        .cell-select { width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1em; background: white; }
        .member-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f1f5f9; gap: 12px; overflow: hidden; }
        .member-item:last-child { border-bottom: none; }
        .member-checkbox { width: 28px; height: 28px; border-radius: 8px; cursor: pointer; accent-color: #4f46e5; }
        .member-info { flex: 1; }
        .member-name { font-weight: 600; color: #1e293b; font-size: 1em; }
        .member-phone { font-size: 0.85em; color: #64748b; margin-top: 3px; }
        .member-status { padding: 6px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; }
        .status-present { background: #dcfce7; color: #16a34a; }
        .status-absent { background: #fee2e2; color: #dc2626; }
        .reason-btn { background: #fef3c7; color: #d97706; border: none; padding: 6px 12px; border-radius: 20px; font-size: 0.75em; cursor: pointer; }
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .stat-box { background: #f8fafc; border-radius: 12px; padding: 12px 8px; text-align: center; overflow: hidden; }
        .stat-number { font-size: 1.3em; font-weight: 700; color: #4f46e5; }
        .stat-label { font-size: 0.7em; color: #64748b; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .report-form { padding: 15px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-textarea { width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1em; resize: vertical; min-height: 100px; font-family: inherit; }
        .form-textarea:focus { outline: none; border-color: #4f46e5; }
        .report-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f1f5f9; gap: 12px; overflow: hidden; }
        .report-cell { font-weight: 600; color: #1e293b; min-width: 60px; max-width: 70px; flex-shrink: 0; font-size: 0.9em; }
        .report-status { padding: 5px 10px; border-radius: 20px; font-size: 0.75em; font-weight: 600; }
        .report-submitted { background: #dcfce7; color: #16a34a; }
        .report-pending { background: #fef3c7; color: #d97706; }
        .report-view-btn { background: #4f46e5; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.8em; cursor: pointer; }
        .date-selector { display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8fafc; border-radius: 12px; margin: 15px; }
        .date-input { flex: 1; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 20px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 1.2em; color: #1e293b; }
        .modal-close { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #64748b; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; justify-content: flex-end; }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 12px 24px; border-radius: 30px; font-size: 0.9em; z-index: 300; display: none; animation: fadeIn 0.3s; }
        .toast.show { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        .hidden { display: none !important; }
        body.offline .header { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }
        body.offline .header::after { content: 'ğŸ“´ ì˜¤í”„ë¼ì¸'; position: absolute; right: 100px; font-size: 0.75em; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 10px; }
        .overview-card { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; border-radius: 16px; padding: 15px; margin: 15px; overflow: hidden; }
        .overview-title { font-size: 0.85em; opacity: 0.9; margin-bottom: 8px; }
        .overview-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .overview-stat { text-align: center; overflow: hidden; }
        .overview-number { font-size: 1.6em; font-weight: 700; }
        .overview-label { font-size: 0.75em; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .progress-bar { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 4px; transition: width 0.5s; }
        .prayer-item { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px 15px; margin-bottom: 10px; border-radius: 0 8px 8px 0; }
        .prayer-name { font-weight: 600; color: #92400e; font-size: 0.85em; }
        .prayer-content { color: #78350f; margin-top: 5px; }
        .phone-link { color: #4f46e5; text-decoration: none; }
        .empty-state { text-align: center; padding: 40px 20px; color: #94a3b8; }
        .empty-icon { font-size: 3em; margin-bottom: 15px; }
        .current-cell-badge { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 1em; display: inline-block; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“ GKC êµ¬ì—­ê´€ë¦¬</h1>
        <button class="header-btn" id="logoutBtn" onclick="logout()" style="display: none;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    
    <div class="main-content">
        <div id="loginScreen" class="login-container">
            <div class="login-box">
                <div class="login-logo">â›ª</div>
                <div class="login-title">GKC êµ¬ì—­ê´€ë¦¬</div>
                <div class="form-group">
                    <label class="form-label">ì•„ì´ë””</label>
                    <input type="text" class="form-input" id="loginUsername" placeholder="ì•„ì´ë”” ì…ë ¥">
                </div>
                <div class="form-group">
                    <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeypress="if(event.key==='Enter') login()">
                </div>
                <button class="btn btn-primary" onclick="login()">ë¡œê·¸ì¸</button>
            </div>
        </div>
        
        <div id="appScreen" class="hidden">
            <div class="cell-selector" id="cellSelector">
                <select class="cell-select" id="cellSelect" onchange="onCellChange()"></select>
            </div>
            
            <div id="tabSunday">
                <div class="date-selector">
                    <span>ğŸ“… ì£¼ì¼ì˜ˆë°° ë‚ ì§œ</span>
                    <input type="date" class="date-input" id="sundayAttendanceDate" onchange="onSundayDateChange()">
                    <button class="btn btn-primary" onclick="setThisSunday()" style="width: auto; padding: 8px 12px; font-size: 0.85em;">ì´ë²ˆì£¼ì¼</button>
                </div>
                <div class="card">
                    <div class="card-title"><span>âœï¸</span><span id="sundayAttendanceTitle">ì£¼ì¼ì˜ˆë°° ì¶œì„</span></div>
                    <div class="stats-row">
                        <div class="stat-box"><div class="stat-number" id="sundayStatTotal">0</div><div class="stat-label">ì „ì²´</div></div>
                        <div class="stat-box"><div class="stat-number" id="sundayStatPresent" style="color: #16a34a;">0</div><div class="stat-label">ì¶œì„</div></div>
                        <div class="stat-box"><div class="stat-number" id="sundayStatAbsent" style="color: #dc2626;">0</div><div class="stat-label">ê²°ì„</div></div>
                    </div>
                    <div id="sundayMemberList"></div>
                </div>
                <div style="padding: 15px;"><button class="btn btn-success" onclick="saveSundayAttendance()">ğŸ’¾ ì£¼ì¼ì˜ˆë°° ì¶œì„ ì €ì¥</button></div>
            </div>
            
            <div id="tabAttendance" class="hidden">
                <div class="date-selector">
                    <span>ğŸ“… êµ¬ì—­ì˜ˆë°° ë‚ ì§œ</span>
                    <input type="date" class="date-input" id="attendanceDate" onchange="onAttendanceDateChange()">
                    <button class="btn btn-primary" onclick="setToday()" style="width: auto; padding: 8px 12px; font-size: 0.85em;">ì˜¤ëŠ˜</button>
                </div>
                <div class="card">
                    <div class="card-title"><span>â›ª</span><span id="attendanceTitle">êµ¬ì—­ì˜ˆë°° ì¶œì„</span></div>
                    <div class="stats-row">
                        <div class="stat-box"><div class="stat-number" id="statTotal">0</div><div class="stat-label">ì „ì²´</div></div>
                        <div class="stat-box"><div class="stat-number" id="statPresent" style="color: #16a34a;">0</div><div class="stat-label">ì¶œì„</div></div>
                        <div class="stat-box"><div class="stat-number" id="statAbsent" style="color: #dc2626;">0</div><div class="stat-label">ê²°ì„</div></div>
                    </div>
                    <div id="memberList"></div>
                </div>
                <div style="padding: 15px;"><button class="btn btn-success" onclick="saveAttendance()">ğŸ’¾ êµ¬ì—­ì˜ˆë°° ì¶œì„ ì €ì¥</button></div>
            </div>
            
            <div id="tabReport" class="hidden">
                <div class="card">
                    <div class="card-title"><span>ğŸ“</span><span>êµ¬ì—­ì˜ˆë°° ë³´ê³ ì„œ</span></div>
                    <!-- í˜„ì¬ êµ¬ì—­ í‘œì‹œ -->
                    <div style="text-align: center; margin-bottom: 15px;">
                        <span class="current-cell-badge" id="reportCurrentCell">êµ¬ì—­ ì„ íƒ</span>
                    </div>
                    <div class="report-form">
                        <div class="form-group">
                            <label class="form-label">ğŸ“… êµ¬ì—­ì˜ˆë°° ë‚ ì§œ</label>
                            <input type="date" class="form-input" id="reportDate">
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">ì˜ˆë°° ì¥ì†Œ</label><input type="text" class="form-input" id="reportPlace" placeholder="ì˜ˆ: ê¹€ì² ìˆ˜ ì§‘"></div>
                            <div class="form-group"><label class="form-label">ì˜ˆë°° ì‹œê°„</label><input type="time" class="form-input" id="reportTime" value="14:00"></div>
                        </div>
                        <div class="form-group"><label class="form-label">ì¸ë„ì</label><input type="text" class="form-input" id="reportLeader" placeholder="ì¸ë„ì ì´ë¦„"></div>
                        <div class="form-group"><label class="form-label">ì°¬ì–‘</label><input type="text" class="form-input" id="reportHymn" placeholder="ì˜ˆ: ì°¬ì†¡ê°€ 94ì¥"></div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">ì„±ê²½ ë³¸ë¬¸</label><input type="text" class="form-input" id="reportScripture" placeholder="ì˜ˆ: ë§ˆíƒœë³µìŒ 5:1-12"></div>
                            <div class="form-group"><label class="form-label">ë§ì”€ ì œëª©</label><input type="text" class="form-input" id="reportTitle" placeholder="ë§ì”€ ì œëª©"></div>
                        </div>
                        <div class="form-group"><label class="form-label">êµ¬ì—­ í—Œê¸ˆ ($)</label><input type="number" class="form-input" id="reportOffering" placeholder="0" min="0"></div>
                        <div class="form-group">
                            <label class="form-label">ğŸ™ ê¸°ë„ì œëª© (ì´ë¦„:ê¸°ë„ë‚´ìš© í˜•ì‹)</label>
                            <textarea class="form-textarea" id="reportPrayer" placeholder="ì˜ˆì‹œ:
í™ê¸¸ë™:ê±´ê°• íšŒë³µì„ ìœ„í•´
ê¹€ì² ìˆ˜:ì§ì¥ì—ì„œì˜ ë¯¿ìŒì„ ìœ„í•´"></textarea>
                        </div>
                        <div class="form-group"><label class="form-label">íŠ¹ì´ì‚¬í•­ / ë‚˜ëˆ”</label><textarea class="form-textarea" id="reportNotes" placeholder="ìƒˆì‹ ì, ê°ì‚¬, ë‚˜ëˆ” ë“±"></textarea></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title"><span>ğŸ“‹</span><span id="reportAttendanceTitle">êµ¬ì—­ì˜ˆë°° ì¶œì„ í˜„í™©</span><button onclick="refreshReportAttendance()" style="margin-left: auto; background: #e2e8f0; border: none; padding: 5px 12px; border-radius: 15px; font-size: 0.8em; cursor: pointer;">ìƒˆë¡œê³ ì¹¨</button></div>
                    <div id="reportAttendanceStatus"><div style="text-align: center; padding: 20px; color: #94a3b8;">êµ¬ì—­ì˜ˆë°° íƒ­ì—ì„œ ë¨¼ì € ì¶œì„ì„ ì²´í¬í•´ì£¼ì„¸ìš”</div></div>
                </div>
                <div style="padding: 15px;"><button class="btn btn-primary" onclick="submitReport()">ğŸ“¤ ë³´ê³ ì„œ ì œì¶œ</button></div>
            </div>
            
            <div id="tabOverview" class="hidden">
                <div class="overview-card" style="background: linear-gradient(135deg, #7c3aed, #8b5cf6);">
                    <div class="overview-title" style="font-size: 1em;">âœï¸ ì£¼ì¼ì˜ˆë°° / ğŸ  êµ¬ì—­ì˜ˆë°°</div>
                    <div class="overview-stats" style="grid-template-columns: repeat(2, 1fr);">
                        <div class="overview-stat"><div class="overview-number" id="sundayOverviewPresent">0</div><div class="overview-label">ì£¼ì¼ ì¶œì„</div></div>
                        <div class="overview-stat"><div class="overview-number" id="cellOverviewPresent">0</div><div class="overview-label">êµ¬ì—­ ì¶œì„</div></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title"><span>ğŸ“Š</span><span>êµ¬ì—­ë³„ ì¶œì„ í˜„í™©</span></div>
                    <div style="font-size: 0.75em; color: #64748b; margin-bottom: 10px;"><span style="color: #8b5cf6;">âœï¸ ì£¼ì¼ì˜ˆë°°</span> / <span style="color: #0891b2;">ğŸ  êµ¬ì—­ì˜ˆë°°</span></div>
                    <div id="overviewList"></div>
                </div>
                <div class="card">
                    <div class="card-title"><span>ğŸ™</span><span>ê¸°ë„ì œëª©</span></div>
                    <div id="prayerList"></div>
                </div>
            </div>
            
            <div id="tabHistory" class="hidden">
                <div class="card">
                    <div class="card-title"><span>ğŸ“š</span><span>ì§€ë‚œ ë³´ê³ ì„œ</span></div>
                    <div id="historyList"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-nav hidden" id="tabNav">
        <button class="tab-btn active" onclick="showTab('sunday')" id="tabBtnSunday"><span class="tab-icon">âœï¸</span><span>ì£¼ì¼ì˜ˆë°°</span></button>
        <button class="tab-btn" onclick="showTab('attendance')" id="tabBtnAttendance"><span class="tab-icon">ğŸ </span><span>êµ¬ì—­ì˜ˆë°°</span></button>
        <button class="tab-btn" onclick="showTab('report')" id="tabBtnReport"><span class="tab-icon">ğŸ“</span><span>ë³´ê³ ì„œ</span></button>
        <button class="tab-btn hidden" onclick="showTab('overview')" id="tabBtnOverview"><span class="tab-icon">ğŸ“Š</span><span>í˜„í™©</span></button>
        <button class="tab-btn" onclick="showTab('history')" id="tabBtnHistory"><span class="tab-icon">ğŸ“š</span><span>ê¸°ë¡</span></button>
    </div>
    
    <div class="modal" id="reasonModal">
        <div class="modal-content">
            <div class="modal-header"><h3>ê²°ì„ ì‚¬ìœ  ì…ë ¥</h3><button class="modal-close" onclick="closeReasonModal()">Ã—</button></div>
            <div class="modal-body">
                <input type="hidden" id="reasonMemberId">
                <div class="form-group"><label class="form-label">ê²°ì„ì: <strong id="reasonMemberName"></strong></label></div>
                <div class="form-group">
                    <label class="form-label">ê²°ì„ ì‚¬ìœ </label>
                    <select class="form-input" id="reasonSelect" onchange="onReasonSelect()">
                        <option value="">-- ì„ íƒ --</option>
                        <option value="ì¶œì¥">ì¶œì¥</option>
                        <option value="ì—¬í–‰">ì—¬í–‰</option>
                        <option value="ì•„í””">ì•„í””/ë³‘ì›</option>
                        <option value="ê°€ì¡±í–‰ì‚¬">ê°€ì¡± í–‰ì‚¬</option>
                        <option value="ì§ì¥">ì§ì¥ ê·¼ë¬´</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€ (ì§ì ‘ì…ë ¥)</option>
                    </select>
                </div>
                <div class="form-group" id="customReasonGroup" style="display: none;"><label class="form-label">ì‚¬ìœ  ì…ë ¥</label><input type="text" class="form-input" id="customReason" placeholder="ê²°ì„ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeReasonModal()" style="width: auto;">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveReason()" style="width: auto;">ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="reportDetailModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="reportDetailTitle">ë³´ê³ ì„œ ìƒì„¸</h3><button class="modal-close" onclick="closeReportDetail()">Ã—</button></div>
            <div class="modal-body" id="reportDetailContent"></div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDxGpjfG5Rfpc8M5-k_xhmt7eYHhwGeVVU",
            authDomain: "gkc-web-project-c87c9.firebaseapp.com",
            projectId: "gkc-web-project-c87c9",
            storageBucket: "gkc-web-project.firebasestorage.app",
            messagingSenderId: "842400243498",
            appId: "1:842400243498:web:2a79694db7a0343e4e3f4c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let currentUser = null, members = [], cells = [], cellAttendance = {}, cellSundayAttendance = {}, cellWorshipDates = {}, cellReports = {}, absentReasons = {}, selectedCell = null, attendanceData = {}, sundayAttendanceData = {};
        
        // ê¸°ë„ì œëª© íŒŒì‹± í•¨ìˆ˜ (ì„±ëª…:ë‚´ìš© í˜•ì‹)
        function formatPrayerContent(prayer) {
            if (!prayer) return '-';
            const lines = prayer.split('\n');
            let result = '';
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                const match = line.match(/^([^:;]+)[:;](.+)$/);
                if (match) {
                    result += '<div style="margin-bottom:8px;"><span style="font-weight:600;color:#b45309;display:inline-block;min-width:50px;">' + match[1].trim() + '</span><span style="color:#78350f;margin-left:8px;">' + match[2].trim() + '</span></div>';
                } else {
                    result += '<div style="margin-bottom:8px;color:#78350f;">' + line + '</div>';
                }
            });
            return result || '-';
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            trackVisitor();
            const savedUser = localStorage.getItem('cellAppUser');
            if (savedUser) { currentUser = JSON.parse(savedUser); initApp(); }
        });
        
        async function trackVisitor() {
            try {
                const now = new Date();
                const today = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
                const page = 'cell.html';
                const sessionKey = 'visited_' + today + '_' + page;
                if (sessionStorage.getItem(sessionKey)) return;
                sessionStorage.setItem(sessionKey, 'true');
                const visitorRef = db.collection('visitorStats').doc('main');
                const doc = await visitorRef.get();
                let data = doc.exists ? doc.data() : { daily: {}, pages: {}, total: 0 };
                if (!data.daily) data.daily = {};
                if (!data.daily[today]) data.daily[today] = 0;
                data.daily[today]++;
                if (!data.pages) data.pages = {};
                if (!data.pages[today]) data.pages[today] = {};
                if (!data.pages[today][page]) data.pages[today][page] = 0;
                data.pages[today][page]++;
                if (!data.total) data.total = 0;
                data.total++;
                await visitorRef.set(data);
            } catch (error) { console.log('ë°©ë¬¸ì ì¶”ì  ì˜¤ë¥˜:', error); }
        }
        
        function setToday() {
            const now = new Date();
            const today = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
            const attendanceDate = document.getElementById('attendanceDate');
            const reportDate = document.getElementById('reportDate');
            if (attendanceDate) { attendanceDate.value = today; localStorage.setItem('cellApp_attendanceDate', today); }
            if (reportDate) reportDate.value = today;
            loadAttendance();
        }
        
        function setThisSunday() {
            const today = new Date();
            const sunday = new Date(today);
            const day = today.getDay();
            if (day !== 0) sunday.setDate(today.getDate() - day);
            const dateStr = `${sunday.getFullYear()}-${String(sunday.getMonth()+1).padStart(2,'0')}-${String(sunday.getDate()).padStart(2,'0')}`;
            const sundayDate = document.getElementById('sundayAttendanceDate');
            if (sundayDate) { sundayDate.value = dateStr; localStorage.setItem('cellApp_sundayDate', dateStr); }
            loadSundayAttendance();
        }
        
        function initDates() {
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            let attDateStr = (selectedCell && cellWorshipDates[selectedCell]) ? cellWorshipDates[selectedCell] : (localStorage.getItem('cellApp_attendanceDate') || todayStr);
            const attendanceDate = document.getElementById('attendanceDate');
            const reportDate = document.getElementById('reportDate');
            if (attendanceDate) attendanceDate.value = attDateStr;
            if (reportDate) reportDate.value = attDateStr;
            const savedSundayDate = localStorage.getItem('cellApp_sundayDate');
            let sundayDateStr;
            if (savedSundayDate) { sundayDateStr = savedSundayDate; }
            else { const sunday = new Date(today); const day = today.getDay(); if (day !== 0) sunday.setDate(today.getDate() - day); sundayDateStr = `${sunday.getFullYear()}-${String(sunday.getMonth()+1).padStart(2,'0')}-${String(sunday.getDate()).padStart(2,'0')}`; }
            const sundayDate = document.getElementById('sundayAttendanceDate');
            if (sundayDate) sundayDate.value = sundayDateStr;
            loadSundayAttendance();
            loadAttendance();
        }
        
        function onAttendanceDateChange() {
            const dateStr = document.getElementById('attendanceDate').value;
            localStorage.setItem('cellApp_attendanceDate', dateStr);
            const reportDate = document.getElementById('reportDate');
            if (reportDate) reportDate.value = dateStr;
            if (selectedCell) {
                cellWorshipDates[selectedCell] = dateStr;
                db.collection('cellWorshipDates').doc('main').set({ data: cellWorshipDates }).catch(err => console.error(err));
            }
            loadAttendance();
        }
        
        function onSundayDateChange() {
            const dateStr = document.getElementById('sundayAttendanceDate').value;
            localStorage.setItem('cellApp_sundayDate', dateStr);
            loadSundayAttendance();
        }
        
        async function login() {
            alert('ë¡œê·¸ì¸ ì‹œë„ ì¤‘...');
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!username || !password) { showToast('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
            try {
                alert('Firebase ì—°ê²° ì¤‘...');
                const usersDoc = await db.collection('registeredUsers').doc('main').get();
                if (!usersDoc.exists) { showToast('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
                const users = usersDoc.data().list || [];
                alert('ì‚¬ìš©ì ìˆ˜: ' + users.length);
                const user = users.find(u => u.username === username && u.password === password);
                if (!user) { showToast('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤'); return; }
                const hasAccess = user.role === 'ê´€ë¦¬ì' || (user.permissions && user.permissions.includes('cell'));
                if (!hasAccess) { showToast('êµ¬ì—­ê´€ë¦¬ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤'); return; }
                currentUser = user;
                localStorage.setItem('cellAppUser', JSON.stringify(user));
                initApp();
                showToast('ë¡œê·¸ì¸ ì„±ê³µ!');
            } catch (error) { console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error); alert('ì˜¤ë¥˜: ' + error.message); showToast('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'); }
        }
        
        async function initApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('tabNav').classList.remove('hidden');
            document.getElementById('logoutBtn').style.display = 'block';
            if (currentUser.role === 'ê´€ë¦¬ì') document.getElementById('tabBtnOverview').classList.remove('hidden');
            await loadData();
            setupRealtimeListeners();
            initCellSelector();
        }
        
        async function loadData() {
            try {
                const membersDoc = await db.collection('churchMembers').doc('main').get();
                if (membersDoc.exists) members = membersDoc.data().list || [];
                const cellsDoc = await db.collection('churchCells').doc('main').get();
                if (cellsDoc.exists) cells = cellsDoc.data().list || [];
                const attDoc = await db.collection('cellAttendance').doc('main').get();
                if (attDoc.exists) cellAttendance = attDoc.data().data || {};
                const sundayAttDoc = await db.collection('cellSundayAttendance').doc('main').get();
                if (sundayAttDoc.exists) cellSundayAttendance = sundayAttDoc.data().data || {};
                const datesDoc = await db.collection('cellWorshipDates').doc('main').get();
                if (datesDoc.exists) cellWorshipDates = datesDoc.data().data || {};
                const reportsDoc = await db.collection('cellReports').doc('main').get();
                if (reportsDoc.exists) cellReports = reportsDoc.data().data || {};
                const reasonsDoc = await db.collection('absentReasons').doc('main').get();
                if (reasonsDoc.exists) absentReasons = reasonsDoc.data().data || {};
            } catch (error) { console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error); showToast('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'); }
        }
        
        function setupRealtimeListeners() {
            db.collection('cellAttendance').doc('main').onSnapshot(doc => { if (doc.exists && doc.data().data) { cellAttendance = doc.data().data; loadAttendance(); } });
            db.collection('cellSundayAttendance').doc('main').onSnapshot(doc => { if (doc.exists && doc.data().data) { cellSundayAttendance = doc.data().data; loadSundayAttendance(); } });
            db.collection('cellWorshipDates').doc('main').onSnapshot(doc => { if (doc.exists && doc.data().data) { cellWorshipDates = doc.data().data; } });
            db.collection('cellReports').doc('main').onSnapshot(doc => { if (doc.exists && doc.data().data) { cellReports = doc.data().data; if (currentUser.role === 'ê´€ë¦¬ì') loadOverview(); loadHistory(); } });
            db.collection('absentReasons').doc('main').onSnapshot(doc => { if (doc.exists && doc.data().data) { absentReasons = doc.data().data; loadAttendance(); } });
            db.collection('churchMembers').doc('main').onSnapshot(doc => { if (doc.exists && doc.data().list) { members = doc.data().list; loadAttendance(); loadSundayAttendance(); } });
            db.collection('churchCells').doc('main').onSnapshot(doc => { if (doc.exists && doc.data().list) { cells = doc.data().list; initCellSelector(); } });
        }
        
        function initCellSelector() {
            const select = document.getElementById('cellSelect');
            select.innerHTML = '';
            let availableCells = [];
            if (currentUser.role === 'ê´€ë¦¬ì') { availableCells = cells; }
            else {
                availableCells = cells.filter(c => c.leaderName === currentUser.name);
                if (availableCells.length === 0) {
                    const member = members.find(m => m.nameKr === currentUser.name);
                    if (member && member.cell) {
                        const cellName = member.cell.replace('êµ¬ì—­', '');
                        const cell = cells.find(c => c.name === cellName || c.name === member.cell);
                        if (cell) availableCells = [cell];
                    }
                }
            }
            if (availableCells.length === 0) { select.innerHTML = '<option value="">ì ‘ê·¼ ê°€ëŠ¥í•œ êµ¬ì—­ì´ ì—†ìŠµë‹ˆë‹¤</option>'; return; }
            availableCells.forEach(cell => {
                const option = document.createElement('option');
                option.value = cell.name;
                option.textContent = cell.name + 'êµ¬ì—­ (êµ¬ì—­ì¥: ' + (cell.leaderName || 'ë¯¸ì§€ì •') + ')';
                select.appendChild(option);
            });
            selectedCell = availableCells[0].name;
            if (availableCells.length === 1 && currentUser.role !== 'ê´€ë¦¬ì') document.getElementById('cellSelector').style.display = 'none';
            updateCurrentCellDisplay();
            initDates();
        }
        
        function updateCurrentCellDisplay() {
            const badge = document.getElementById('reportCurrentCell');
            const titleEl = document.getElementById('reportAttendanceTitle');
            if (badge && selectedCell) {
                badge.textContent = 'ğŸ  ' + selectedCell + 'êµ¬ì—­';
            }
            if (titleEl && selectedCell) {
                titleEl.textContent = selectedCell + 'êµ¬ì—­ ì¶œì„ í˜„í™©';
            }
        }
        
        function onCellChange() {
            selectedCell = document.getElementById('cellSelect').value;
            if (selectedCell && cellWorshipDates[selectedCell]) {
                const dateInput = document.getElementById('attendanceDate');
                if (dateInput) dateInput.value = cellWorshipDates[selectedCell];
            }
            updateCurrentCellDisplay();
            loadAttendance();
            loadSundayAttendance();
            refreshReportAttendance();
        }
        
        function loadAttendance() {
            if (!selectedCell) return;
            const dateStr = document.getElementById('attendanceDate').value;
            const cell = cells.find(c => c.name === selectedCell);
            if (!cell) return;
            const cellMembers = members.filter(m => { const mc = (m.cell || '').replace('êµ¬ì—­', ''); return mc === selectedCell || m.cell === selectedCell + 'êµ¬ì—­'; });
            if (cell.leaderName) { const leader = members.find(m => m.nameKr === cell.leaderName); if (leader && !cellMembers.find(m => m.nameKr === cell.leaderName)) cellMembers.unshift(leader); }
            document.getElementById('attendanceTitle').textContent = selectedCell + 'êµ¬ì—­ êµ¬ì—­ì˜ˆë°° ì¶œì„';
            const key = selectedCell + '_' + dateStr;
            const savedAttendance = cellAttendance[key] || [];
            attendanceData = {};
            cellMembers.forEach(m => { attendanceData[m.nameKr] = savedAttendance.includes(m.nameKr); });
            const container = document.getElementById('memberList');
            if (cellMembers.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div>êµ¬ì—­ì›ì´ ì—†ìŠµë‹ˆë‹¤</div></div>'; updateStats(); return; }
            let html = '';
            cellMembers.forEach(m => {
                const isPresent = attendanceData[m.nameKr];
                const isLeader = m.nameKr === cell.leaderName;
                const reasonKey = selectedCell + '_' + dateStr + '_' + m.nameKr;
                const reason = absentReasons[reasonKey] || '';
                html += '<div class="member-item"><input type="checkbox" class="member-checkbox" ' + (isPresent ? 'checked' : '') + ' onchange="toggleAttendance(\'' + m.nameKr + '\', this.checked)"><div class="member-info"><div class="member-name">' + m.nameKr + (isLeader ? '<span style="color: #4f46e5; font-size: 0.8em;">(êµ¬ì—­ì¥)</span>' : '') + '<a href="tel:' + (m.phone || '') + '" class="phone-link" style="color: #64748b; font-size: 0.85em; margin-left: 8px;">' + (m.phone || '') + '</a></div></div>' + (isPresent ? '<span class="member-status status-present">ì¶œì„</span>' : '<button class="reason-btn" onclick="openReasonModal(\'' + m.nameKr + '\')">' + (reason || 'ì‚¬ìœ ì…ë ¥') + '</button>') + '</div>';
            });
            container.innerHTML = html;
            updateStats();
        }
        
        async function toggleAttendance(name, checked) {
            attendanceData[name] = checked;
            const dateStr = document.getElementById('attendanceDate').value;
            const key = selectedCell + '_' + dateStr;
            const presentList = Object.keys(attendanceData).filter(n => attendanceData[n]);
            cellAttendance[key] = presentList;
            localStorage.setItem('cellAttendance', JSON.stringify(cellAttendance));
            try { await db.collection('cellAttendance').doc('main').set({ data: cellAttendance }); } catch (error) { console.error(error); }
            loadAttendance();
        }
        
        function updateStats() {
            const total = Object.keys(attendanceData).length;
            const present = Object.values(attendanceData).filter(v => v).length;
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statPresent').textContent = present;
            document.getElementById('statAbsent').textContent = total - present;
        }
        
        function openReasonModal(name) {
            const dateStr = document.getElementById('attendanceDate').value;
            const reasonKey = selectedCell + '_' + dateStr + '_' + name;
            const savedReason = absentReasons[reasonKey] || '';
            document.getElementById('reasonMemberId').value = name;
            document.getElementById('reasonMemberName').textContent = name;
            document.getElementById('reasonSelect').value = '';
            document.getElementById('customReason').value = '';
            document.getElementById('customReasonGroup').style.display = 'none';
            if (savedReason) {
                const options = ['ì¶œì¥', 'ì—¬í–‰', 'ì•„í””', 'ê°€ì¡±í–‰ì‚¬', 'ì§ì¥'];
                if (options.includes(savedReason)) document.getElementById('reasonSelect').value = savedReason;
                else { document.getElementById('reasonSelect').value = 'ê¸°íƒ€'; document.getElementById('customReason').value = savedReason; document.getElementById('customReasonGroup').style.display = 'block'; }
            }
            document.getElementById('reasonModal').classList.add('active');
        }
        
        function onReasonSelect() { document.getElementById('customReasonGroup').style.display = document.getElementById('reasonSelect').value === 'ê¸°íƒ€' ? 'block' : 'none'; }
        
        function saveReason() {
            const name = document.getElementById('reasonMemberId').value;
            const dateStr = document.getElementById('attendanceDate').value;
            let reason = document.getElementById('reasonSelect').value;
            if (reason === 'ê¸°íƒ€') reason = document.getElementById('customReason').value.trim();
            absentReasons[selectedCell + '_' + dateStr + '_' + name] = reason;
            closeReasonModal();
            loadAttendance();
            showToast('ê²°ì„ ì‚¬ìœ ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
        
        function closeReasonModal() { document.getElementById('reasonModal').classList.remove('active'); }
        
        async function saveAttendance() {
            if (!selectedCell) return;
            const dateStr = document.getElementById('attendanceDate').value;
            const key = selectedCell + '_' + dateStr;
            cellAttendance[key] = Object.keys(attendanceData).filter(name => attendanceData[name]);
            try {
                await db.collection('cellAttendance').doc('main').set({ data: cellAttendance });
                await db.collection('absentReasons').doc('main').set({ data: absentReasons });
                showToast('âœ… êµ¬ì—­ì˜ˆë°° ì¶œì„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) { console.error(error); showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'); }
        }
        
        function loadSundayAttendance() {
            if (!selectedCell) return;
            const dateStr = document.getElementById('sundayAttendanceDate').value;
            if (!dateStr) return;
            const cell = cells.find(c => c.name === selectedCell);
            if (!cell) return;
            const cellMembers = members.filter(m => { const mc = (m.cell || '').replace('êµ¬ì—­', ''); return mc === selectedCell || m.cell === selectedCell + 'êµ¬ì—­'; });
            if (cell.leaderName) { const leader = members.find(m => m.nameKr === cell.leaderName); if (leader && !cellMembers.find(m => m.nameKr === cell.leaderName)) cellMembers.unshift(leader); }
            document.getElementById('sundayAttendanceTitle').textContent = selectedCell + 'êµ¬ì—­ ì£¼ì¼ì˜ˆë°° ì¶œì„';
            const key = selectedCell + '_' + dateStr;
            const savedAttendance = cellSundayAttendance[key] || [];
            sundayAttendanceData = {};
            cellMembers.forEach(m => { sundayAttendanceData[m.nameKr] = savedAttendance.includes(m.nameKr); });
            const container = document.getElementById('sundayMemberList');
            if (cellMembers.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div>êµ¬ì—­ì›ì´ ì—†ìŠµë‹ˆë‹¤</div></div>'; updateSundayStats(); return; }
            let html = '';
            cellMembers.forEach(m => {
                const isPresent = sundayAttendanceData[m.nameKr];
                const isLeader = m.nameKr === cell.leaderName;
                html += '<div class="member-item"><input type="checkbox" class="member-checkbox" ' + (isPresent ? 'checked' : '') + ' onchange="toggleSundayAttendance(\'' + m.nameKr + '\', this.checked)"><div class="member-info"><div class="member-name">' + m.nameKr + (isLeader ? '<span style="color: #4f46e5; font-size: 0.8em;">(êµ¬ì—­ì¥)</span>' : '') + '<a href="tel:' + (m.phone || '') + '" class="phone-link" style="color: #64748b; font-size: 0.85em; margin-left: 8px;">' + (m.phone || '') + '</a></div></div><span class="member-status ' + (isPresent ? 'status-present' : 'status-absent') + '">' + (isPresent ? 'ì¶œì„' : 'ê²°ì„') + '</span></div>';
            });
            container.innerHTML = html;
            updateSundayStats();
        }
        
        async function toggleSundayAttendance(name, checked) {
            sundayAttendanceData[name] = checked;
            const dateStr = document.getElementById('sundayAttendanceDate').value;
            const key = selectedCell + '_' + dateStr;
            cellSundayAttendance[key] = Object.keys(sundayAttendanceData).filter(n => sundayAttendanceData[n]);
            try { await db.collection('cellSundayAttendance').doc('main').set({ data: cellSundayAttendance }); } catch (error) { console.error(error); }
            updateSundayStats();
            loadSundayAttendance();
        }
        
        function updateSundayStats() {
            const total = Object.keys(sundayAttendanceData).length;
            const present = Object.values(sundayAttendanceData).filter(v => v).length;
            document.getElementById('sundayStatTotal').textContent = total;
            document.getElementById('sundayStatPresent').textContent = present;
            document.getElementById('sundayStatAbsent').textContent = total - present;
        }
        
        async function saveSundayAttendance() {
            if (!selectedCell) return;
            const dateStr = document.getElementById('sundayAttendanceDate').value;
            cellSundayAttendance[selectedCell + '_' + dateStr] = Object.keys(sundayAttendanceData).filter(name => sundayAttendanceData[name]);
            try { await db.collection('cellSundayAttendance').doc('main').set({ data: cellSundayAttendance }); showToast('âœ… ì£¼ì¼ì˜ˆë°° ì¶œì„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!'); }
            catch (error) { console.error(error); showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'); }
        }
        
        function refreshReportAttendance() {
            if (!selectedCell) { document.getElementById('reportAttendanceStatus').innerHTML = '<div style="text-align: center; padding: 20px; color: #94a3b8;">êµ¬ì—­ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”</div>'; return; }
            const dateStr = document.getElementById('reportDate').value;
            const key = selectedCell + '_' + dateStr;
            const presentList = cellAttendance[key] || [];
            const cell = cells.find(c => c.name === selectedCell);
            if (!cell) return;
            
            // í˜„ì¬ êµ¬ì—­ í‘œì‹œ ì—…ë°ì´íŠ¸
            updateCurrentCellDisplay();
            
            const cellMembers = members.filter(m => { const mc = (m.cell || '').replace('êµ¬ì—­', ''); return mc === selectedCell || m.cell === selectedCell + 'êµ¬ì—­'; });
            const allMembers = [];
            if (cell.leaderName) allMembers.push({ nameKr: cell.leaderName, isLeader: true });
            cellMembers.forEach(m => { if (m.nameKr !== cell.leaderName) allMembers.push({ nameKr: m.nameKr, isLeader: false }); });
            const absentList = allMembers.filter(m => !presentList.includes(m.nameKr));
            let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"><div style="background: #dcfce7; border-radius: 12px; padding: 15px;"><div style="font-weight: 600; color: #16a34a; margin-bottom: 10px;">âœ… ì¶œì„ (' + presentList.length + 'ëª…)</div>';
            if (presentList.length > 0) presentList.forEach(name => { const m = allMembers.find(x => x.nameKr === name); html += '<div style="font-size: 0.9em; padding: 3px 0; color: #166534;">' + name + (m && m.isLeader ? ' (êµ¬ì—­ì¥)' : '') + '</div>'; });
            else html += '<div style="font-size: 0.85em; color: #94a3b8;">ì—†ìŒ</div>';
            html += '</div><div style="background: #fee2e2; border-radius: 12px; padding: 15px;"><div style="font-weight: 600; color: #dc2626; margin-bottom: 10px;">âŒ ê²°ì„ (' + absentList.length + 'ëª…)</div>';
            if (absentList.length > 0) absentList.forEach(m => { const rk = selectedCell + '_' + dateStr + '_' + m.nameKr; const r = absentReasons[rk] || ''; html += '<div style="font-size: 0.9em; padding: 3px 0; color: #991b1b;">' + m.nameKr + (m.isLeader ? ' (êµ¬ì—­ì¥)' : '') + (r ? ' <span style="font-size: 0.8em; color: #dc2626;">- ' + r + '</span>' : '') + '</div>'; });
            else html += '<div style="font-size: 0.85em; color: #94a3b8;">ì—†ìŒ</div>';
            html += '</div></div><div style="text-align: center; margin-top: 15px; padding: 10px; background: #f1f5f9; border-radius: 10px;"><span style="font-weight: 600;">ì¶œì„ë¥ : </span><span style="color: ' + ((presentList.length / allMembers.length * 100) >= 70 ? '#16a34a' : '#dc2626') + '; font-weight: 700;">' + (allMembers.length > 0 ? Math.round(presentList.length / allMembers.length * 100) : 0) + '%</span><span style="color: #64748b; font-size: 0.9em;"> (' + presentList.length + '/' + allMembers.length + 'ëª…)</span></div>';
            document.getElementById('reportAttendanceStatus').innerHTML = html;
        }
        
        async function submitReport() {
            if (!selectedCell) { showToast('êµ¬ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
            const dateStr = document.getElementById('reportDate').value;
            if (!dateStr) { showToast('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
            const key = selectedCell + '_' + dateStr;
            const cell = cells.find(c => c.name === selectedCell);
            const cellMembers = members.filter(m => { const mc = (m.cell || '').replace('êµ¬ì—­', ''); return mc === selectedCell || m.cell === selectedCell + 'êµ¬ì—­'; });
            const allMembers = [];
            if (cell && cell.leaderName) allMembers.push(cell.leaderName);
            cellMembers.forEach(m => { if (m.nameKr && m.nameKr !== cell?.leaderName) allMembers.push(m.nameKr); });
            const presentList = cellAttendance[key] || [];
            const absentList = allMembers.filter(name => !presentList.includes(name));
            const absentWithReasons = absentList.map(name => ({ name: name, reason: absentReasons[selectedCell + '_' + dateStr + '_' + name] || '' }));
            const report = {
                cell: selectedCell,
                cellName: selectedCell,
                date: dateStr,
                place: document.getElementById('reportPlace').value,
                time: document.getElementById('reportTime').value,
                leader: document.getElementById('reportLeader').value,
                hymn: document.getElementById('reportHymn').value,
                scripture: document.getElementById('reportScripture').value,
                title: document.getElementById('reportTitle').value,
                offering: parseInt(document.getElementById('reportOffering').value) || 0,
                prayer: document.getElementById('reportPrayer').value,
                notes: document.getElementById('reportNotes').value,
                attendance: presentList, absent: absentWithReasons,
                totalMembers: allMembers.length,
                attendanceRate: allMembers.length > 0 ? Math.round(presentList.length / allMembers.length * 100) : 0,
                submittedAt: new Date().toISOString(), submittedBy: currentUser.name
            };
            if (!report.place || !report.leader) { showToast('ì˜ˆë°° ì¥ì†Œì™€ ì¸ë„ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
            cellReports[key] = report;
            try {
                await db.collection('cellReports').doc('main').set({ data: cellReports });
                showToast('ğŸ“¤ ë³´ê³ ì„œê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!');
                ['reportPlace', 'reportLeader', 'reportHymn', 'reportScripture', 'reportTitle', 'reportOffering', 'reportPrayer', 'reportNotes'].forEach(id => document.getElementById(id).value = '');
            } catch (error) { console.error(error); showToast('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'); }
        }
        
        async function loadOverview() {
            let sundayTotalAttendance = 0, cellTotalAttendance = 0, totalMembers = 0;
            let listHtml = '';
            const lastSunday = getLastSunday();
            
            cells.forEach(cell => {
                // ì£¼ì¼ì˜ˆë°°: ì§€ë‚œ ì£¼ì¼ ê¸°ì¤€
                const sundayKey = cell.name + '_' + lastSunday;
                const sundayAtt = cellSundayAttendance[sundayKey] || [];
                
                // êµ¬ì—­ì˜ˆë°°: í•´ë‹¹ êµ¬ì—­ì˜ ìµœì‹  ë‚ ì§œ ê¸°ì¤€
                const cellDate = cellWorshipDates[cell.name] || getLatestCellDate(cell.name);
                const cellKey = cell.name + '_' + cellDate;
                const cellAtt = cellAttendance[cellKey] || [];
                const report = cellReports[cellKey];
                
                const cellMembers = members.filter(m => { const mc = (m.cell || '').replace('êµ¬ì—­', ''); return mc === cell.name || m.cell === cell.name + 'êµ¬ì—­'; });
                const cellTotal = cellMembers.length + (cell.leaderName ? 1 : 0);
                totalMembers += cellTotal;
                
                const sundayRate = cellTotal > 0 ? Math.round((sundayAtt.length / cellTotal) * 100) : 0;
                const cellRate = cellTotal > 0 ? Math.round((cellAtt.length / cellTotal) * 100) : 0;
                
                sundayTotalAttendance += sundayAtt.length;
                cellTotalAttendance += cellAtt.length;
                
                listHtml += `
                    <div class="report-item" style="flex-direction: column; align-items: stretch; gap: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div class="report-cell">${cell.name}êµ¬ì—­</div>
                            <div><span class="report-status ${report ? 'report-submitted' : 'report-pending'}">${report ? 'âœ… ë³´ê³ ì„œ' : 'â³ ë¯¸ì œì¶œ'}</span>
                            ${report ? `<button class="report-view-btn" onclick="viewReport('${cell.name}', '${cellDate}')">ë³´ê¸°</button>` : ''}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div style="background: #ede9fe; padding: 8px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 0.7em; color: #7c3aed;">âœï¸ ì£¼ì¼ì˜ˆë°°</div>
                                <div style="font-weight: 600; color: #5b21b6;">${sundayAtt.length}/${cellTotal} <span style="font-size: 0.8em; font-weight: normal;">(${sundayRate}%)</span></div>
                            </div>
                            <div style="background: #e0f2fe; padding: 8px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 0.7em; color: #0891b2;">ğŸ  êµ¬ì—­ì˜ˆë°° ${cellDate ? '(' + cellDate.substring(5) + ')' : ''}</div>
                                <div style="font-weight: 600; color: #0e7490;">${cellAtt.length}/${cellTotal} <span style="font-size: 0.8em; font-weight: normal;">(${cellRate}%)</span></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('sundayOverviewPresent').textContent = sundayTotalAttendance;
            document.getElementById('cellOverviewPresent').textContent = cellTotalAttendance;
            document.getElementById('overviewList').innerHTML = listHtml || '<div class="empty-state">êµ¬ì—­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            
            // ê° êµ¬ì—­ë³„ ìµœì‹  ë³´ê³ ì„œì—ì„œ ê¸°ë„ì œëª© ê°€ì ¸ì˜¤ê¸°
            let prayerHtml = '';
            
            // ëª¨ë“  ë³´ê³ ì„œì—ì„œ ê¸°ë„ì œëª© ì°¾ê¸°
            let allPrayers = [];
            Object.keys(cellReports).forEach(key => {
                const report = cellReports[key];
                if (!report) return;
                
                const cellName = report.cell || report.cellName || key.split('_')[0];
                const reportDate = report.date || key.split('_')[1];
                const prayer = report.prayer;
                
                if (cellName && cellName !== 'undefined' && prayer && prayer.trim()) {
                    allPrayers.push({
                        cellName: cellName,
                        date: reportDate,
                        prayer: prayer,
                        leader: report.leader || ''
                    });
                }
            });
            
            // êµ¬ì—­ë³„ë¡œ ê·¸ë£¹í™”í•˜ê³  ìµœì‹  ê²ƒë§Œ ì„ íƒ
            let latestPrayers = {};
            allPrayers.forEach(p => {
                if (!latestPrayers[p.cellName] || p.date > latestPrayers[p.cellName].date) {
                    latestPrayers[p.cellName] = p;
                }
            });
            
            // ê¸°ë„ì œëª© í‘œì‹œ
            Object.values(latestPrayers).forEach(p => {
                const dateObj = new Date(p.date);
                const dateLabel = (dateObj.getMonth() + 1) + '/' + dateObj.getDate();
                prayerHtml += `
                    <div class="prayer-item">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dashed #fcd34d;">
                            <span class="prayer-name" style="font-size: 1em;">ğŸ  ${p.cellName}êµ¬ì—­</span>
                            <span style="font-size: 0.75em; color: #b45309; background: #fef3c7; padding: 2px 8px; border-radius: 10px;">${dateLabel} Â· ${p.leader}</span>
                        </div>
                        <div class="prayer-content">${formatPrayerContent(p.prayer)}</div>
                    </div>
                `;
            });
            
            document.getElementById('prayerList').innerHTML = prayerHtml || '<div class="empty-state"><div style="font-size: 2em; margin-bottom: 10px;">ğŸ™</div>ê¸°ë„ì œëª©ì´ ì—†ìŠµë‹ˆë‹¤<div style="font-size: 0.8em; margin-top: 10px; color: #94a3b8;">ë³´ê³ ì„œì— ê¸°ë„ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</div></div>';
        }
        
        function getLastSunday() {
            const today = new Date();
            const day = today.getDay();
            const diff = day === 0 ? 0 : day;
            const sunday = new Date(today);
            sunday.setDate(today.getDate() - diff);
            
            // ë¡œì»¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ YYYY-MM-DD í˜•ì‹ ë°˜í™˜
            const year = sunday.getFullYear();
            const month = String(sunday.getMonth() + 1).padStart(2, '0');
            const date = String(sunday.getDate()).padStart(2, '0');
            return `${year}-${month}-${date}`;
        }
        
        function getLatestCellDate(cellName) {
            let latestDate = null;
            Object.keys(cellAttendance).forEach(key => {
                if (key.startsWith(cellName + '_')) {
                    const date = key.split('_')[1];
                    if (!latestDate || date > latestDate) latestDate = date;
                }
            });
            return latestDate || getLastSunday();
        }
        
        function viewReport(cellName, dateStr) {
            const key = cellName + '_' + dateStr;
            const report = cellReports[key];
            if (!report) return;
            const date = new Date(dateStr);
            const dateLabel = (date.getMonth() + 1) + 'ì›” ' + date.getDate() + 'ì¼';
            const presentList = report.attendance || [];
            const absentList = report.absent || [];
            const totalMembers = report.totalMembers || (presentList.length + absentList.length);
            const attendanceRate = report.attendanceRate || (totalMembers > 0 ? Math.round(presentList.length / totalMembers * 100) : 0);
            document.getElementById('reportDetailTitle').textContent = cellName + 'êµ¬ì—­ ë³´ê³ ì„œ (' + dateLabel + ')';
            let absentHtml = '';
            if (absentList.length > 0) absentList.forEach(item => { const name = typeof item === 'string' ? item : item.name; const reason = typeof item === 'object' ? item.reason : ''; absentHtml += '<div style="font-size: 0.9em; color: #991b1b; padding: 2px 0;">' + name + (reason ? ' <span style="font-size: 0.8em; color: #b91c1c;">(' + reason + ')</span>' : '') + '</div>'; });
            else absentHtml = '<div style="color: #94a3b8; font-size: 0.85em;">ì—†ìŒ</div>';
            let presentHtml = '';
            if (presentList.length > 0) presentList.forEach(name => { presentHtml += '<div style="font-size: 0.9em; color: #166534; padding: 2px 0;">' + name + '</div>'; });
            else presentHtml = '<div style="color: #94a3b8; font-size: 0.85em;">ì—†ìŒ</div>';
            document.getElementById('reportDetailContent').innerHTML = '<div style="display: grid; gap: 15px;"><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"><div><strong>ì˜ˆë°° ì¥ì†Œ:</strong> ' + (report.place || '-') + '</div><div><strong>ì˜ˆë°° ì‹œê°„:</strong> ' + (report.time || '-') + '</div></div><div><strong>ì¸ë„ì:</strong> ' + (report.leader || '-') + '</div><div><strong>ì°¬ì–‘:</strong> ' + (report.hymn || '-') + '</div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"><div><strong>ë³¸ë¬¸:</strong> ' + (report.scripture || '-') + '</div><div><strong>ì œëª©:</strong> ' + (report.title || '-') + '</div></div><div style="background: #f1f5f9; padding: 15px; border-radius: 10px; text-align: center;"><div style="font-size: 1.5em; font-weight: 700; color: ' + (attendanceRate >= 70 ? '#16a34a' : '#dc2626') + ';">ì¶œì„ë¥  ' + attendanceRate + '%</div><div style="color: #64748b; margin-top: 5px;">' + presentList.length + 'ëª… ì¶œì„ / ' + absentList.length + 'ëª… ê²°ì„ (ì „ì²´ ' + totalMembers + 'ëª…)</div></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"><div style="background: #dcfce7; padding: 15px; border-radius: 10px;"><div style="font-weight: 600; color: #16a34a; margin-bottom: 10px;">âœ… ì¶œì„ (' + presentList.length + 'ëª…)</div>' + presentHtml + '</div><div style="background: #fee2e2; padding: 15px; border-radius: 10px;"><div style="font-weight: 600; color: #dc2626; margin-bottom: 10px;">âŒ ê²°ì„ (' + absentList.length + 'ëª…)</div>' + absentHtml + '</div></div><div><strong>êµ¬ì—­í—Œê¸ˆ:</strong> $' + (report.offering || 0) + '</div><div style="background: #fef3c7; padding: 15px; border-radius: 10px;"><strong>ğŸ™ ê¸°ë„ì œëª©</strong><div style="margin-top: 10px;">' + formatPrayerContent(report.prayer) + '</div></div><div style="background: #f1f5f9; padding: 15px; border-radius: 10px;"><strong>ğŸ“ íŠ¹ì´ì‚¬í•­</strong><div style="margin-top: 10px; white-space: pre-wrap;">' + (report.notes || '-') + '</div></div><div style="font-size: 0.8em; color: #94a3b8; text-align: right;">ì œì¶œ: ' + (report.submittedBy || '-') + ' (' + new Date(report.submittedAt).toLocaleString('ko-KR') + ')</div></div>';
            document.getElementById('reportDetailModal').classList.add('active');
        }
        
        function closeReportDetail() { document.getElementById('reportDetailModal').classList.remove('active'); }
        
        function loadHistory() {
            const container = document.getElementById('historyList');
            let reports = [];
            Object.keys(cellReports).forEach(key => {
                const report = cellReports[key];
                if (!report) return;
                // êµ¬ì—­ëª… í™•ì¸ - keyì—ì„œ ì¶”ì¶œ ë˜ëŠ” reportì—ì„œ ê°€ì ¸ì˜¤ê¸°
                const cellName = report.cell || report.cellName || key.split('_')[0];
                if (!cellName || cellName === 'undefined') return; // undefined ì œì™¸
                if (currentUser.role === 'ê´€ë¦¬ì' || cellName === selectedCell) {
                    reports.push({ key, cellName, ...report });
                }
            });
            reports.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
            if (reports.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“š</div><div>ì‘ì„±í•œ ë³´ê³ ì„œê°€ ì—†ìŠµë‹ˆë‹¤</div></div>'; return; }
            let html = '';
            reports.slice(0, 20).forEach(report => {
                const date = new Date(report.date);
                const dateLabel = (date.getMonth() + 1) + 'ì›” ' + date.getDate() + 'ì¼';
                const cellName = report.cellName || report.cell || 'ë¯¸ì§€ì •';
                html += `<div class="report-item" onclick="viewReport('${cellName}', '${report.date}')"><div class="report-cell">${cellName}</div><div style="flex: 1; min-width: 0; overflow: hidden;"><div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${dateLabel}</div><div style="font-size: 0.75em; color: #64748b; white-space: nowrap;">ì°¸ì„ ${(report.attendance?.length || 0)}ëª… | í—Œê¸ˆ $${(report.offering || 0)}</div></div><span style="color: #4f46e5; flex-shrink: 0;">â†’</span></div>`;
            });
            });
            container.innerHTML = html;
        }
        
        function showTab(tab) {
            ['Attendance', 'Sunday', 'Report', 'Overview', 'History'].forEach(t => document.getElementById('tab' + t).classList.add('hidden'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tabBtn' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            if (tab === 'overview') loadOverview();
            else if (tab === 'history') loadHistory();
            else if (tab === 'report') { updateCurrentCellDisplay(); setTimeout(() => refreshReportAttendance(), 100); }
            else if (tab === 'sunday' && selectedCell) loadSundayAttendance();
        }
        
        function logout() {
            localStorage.removeItem('cellAppUser');
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('tabNav').classList.add('hidden');
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            showToast('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤');
        }
        
        function showToast(message) { const toast = document.getElementById('toast'); toast.textContent = message; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); }
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker-cell.js').then(reg => { reg.addEventListener('updatefound', () => { const nw = reg.installing; nw.addEventListener('statechange', () => { if (nw.state === 'installed' && navigator.serviceWorker.controller) { showToast('ğŸ”„ ì•± ì—…ë°ì´íŠ¸ ì¤‘...'); nw.postMessage('skipWaiting'); } }); }); }).catch(err => console.error(err));
            navigator.serviceWorker.addEventListener('controllerchange', () => window.location.reload());
            setInterval(() => { navigator.serviceWorker.getRegistration().then(reg => { if (reg) reg.update(); }); }, 60000);
        }
        function updateOnlineStatus() { if (navigator.onLine) document.body.classList.remove('offline'); else { document.body.classList.add('offline'); showToast('ğŸ“´ ì˜¤í”„ë¼ì¸ ëª¨ë“œ'); } }
        window.addEventListener('online', () => { updateOnlineStatus(); showToast('âœ… ì˜¨ë¼ì¸ ë³µê·€'); if (currentUser) loadData().then(() => { loadAttendance(); loadSundayAttendance(); }); });
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();
    </script>
</body>
</html>
