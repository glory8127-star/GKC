<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <title>GKC êµ¬ì—­ê´€ë¦¬</title>
    <link rel="manifest" href="manifest-cell.json">
    <link rel="apple-touch-icon" href="https://sacglory.church/icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            color: #333;
        }
        
        /* í—¤ë” */
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
        }
        
        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content {
            padding-top: 70px;
            padding-bottom: 80px;
            min-height: 100vh;
        }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 70px);
            padding: 20px;
        }
        
        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            width: 100%;
            max-width: 350px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .login-logo {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .login-title {
            font-size: 1.5em;
            color: #4f46e5;
            margin-bottom: 30px;
            font-weight: 700;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-label {
            display: block;
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(79, 70, 229, 0.4);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
        .tab-nav {
            display: flex;
            background: white;
            padding: 10px;
            gap: 10px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: #f1f5f9;
            border-radius: 12px;
            font-size: 0.85em;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: #64748b;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }
        
        .tab-icon {
            font-size: 1.3em;
        }
        
        /* ì¹´ë“œ */
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .card-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* êµ¬ì—­ ì„ íƒ */
        .cell-selector {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .cell-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1em;
            background: white;
        }
        
        /* ì¶œì„ ì²´í¬ ë¦¬ìŠ¤íŠ¸ */
        .member-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            gap: 15px;
        }
        
        .member-item:last-child {
            border-bottom: none;
        }
        
        .member-checkbox {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            cursor: pointer;
            accent-color: #4f46e5;
        }
        
        .member-info {
            flex: 1;
        }
        
        .member-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 1em;
        }
        
        .member-phone {
            font-size: 0.85em;
            color: #64748b;
            margin-top: 3px;
        }
        
        .member-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .status-present {
            background: #dcfce7;
            color: #16a34a;
        }
        
        .status-absent {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .reason-btn {
            background: #fef3c7;
            color: #d97706;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            cursor: pointer;
        }
        
        /* í†µê³„ */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5em;
            font-weight: 700;
            color: #4f46e5;
        }
        
        .stat-label {
            font-size: 0.75em;
            color: #64748b;
            margin-top: 5px;
        }
        
        /* ë³´ê³ ì„œ í¼ */
        .report-form {
            padding: 15px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .form-textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1em;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: #4f46e5;
        }
        
        /* ë³´ê³ ì„œ ëª©ë¡ (ê´€ë¦¬ììš©) */
        .report-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            gap: 15px;
        }
        
        .report-cell {
            font-weight: 600;
            color: #1e293b;
            min-width: 80px;
        }
        
        .report-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .report-submitted {
            background: #dcfce7;
            color: #16a34a;
        }
        
        .report-pending {
            background: #fef3c7;
            color: #d97706;
        }
        
        .report-view-btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            cursor: pointer;
        }
        
        /* ë‚ ì§œ ì„ íƒ */
        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            margin: 15px;
        }
        
        .date-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }
        
        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 1.2em;
            color: #1e293b;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #64748b;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* ì•Œë¦¼ í† ìŠ¤íŠ¸ */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 0.9em;
            z-index: 300;
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .toast.show {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        /* ìˆ¨ê¹€ */
        .hidden {
            display: none !important;
        }
        
        /* ì˜¤í”„ë¼ì¸ ìƒíƒœ */
        body.offline .header {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }
        
        body.offline .header::after {
            content: 'ğŸ“´ ì˜¤í”„ë¼ì¸';
            position: absolute;
            right: 100px;
            font-size: 0.75em;
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 10px;
        }
        
        /* ê´€ë¦¬ì ì „ì²´ í˜„í™© */
        .overview-card {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border-radius: 16px;
            padding: 20px;
            margin: 15px;
        }
        
        .overview-title {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .overview-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .overview-stat {
            text-align: center;
        }
        
        .overview-number {
            font-size: 2em;
            font-weight: 700;
        }
        
        .overview-label {
            font-size: 0.8em;
            opacity: 0.8;
        }
        
        /* í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 4px;
            transition: width 0.5s;
        }
        
        /* ê¸°ë„ì œëª© ì•„ì´í…œ */
        .prayer-item {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }
        
        .prayer-name {
            font-weight: 600;
            color: #92400e;
            font-size: 0.85em;
        }
        
        .prayer-content {
            color: #78350f;
            margin-top: 5px;
        }
        
        /* ì—°ë½ì²˜ ë§í¬ */
        .phone-link {
            color: #4f46e5;
            text-decoration: none;
        }
        
        /* ë¹ˆ ìƒíƒœ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
        }
        
        .empty-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <div class="header">
        <h1>ğŸ“ GKC êµ¬ì—­ê´€ë¦¬</h1>
        <button class="header-btn" id="logoutBtn" onclick="logout()" style="display: none;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    
    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="main-content">
        <!-- ë¡œê·¸ì¸ í™”ë©´ -->
        <div id="loginScreen" class="login-container">
            <div class="login-box">
                <div class="login-logo">â›ª</div>
                <div class="login-title">GKC êµ¬ì—­ê´€ë¦¬</div>
                <div class="form-group">
                    <label class="form-label">ì•„ì´ë””</label>
                    <input type="text" class="form-input" id="loginUsername" placeholder="ì•„ì´ë”” ì…ë ¥">
                </div>
                <div class="form-group">
                    <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeypress="if(event.key==='Enter') login()">
                </div>
                <button class="btn btn-primary" onclick="login()">ë¡œê·¸ì¸</button>
            </div>
        </div>
        
        <!-- ì•± í™”ë©´ (ë¡œê·¸ì¸ í›„) -->
        <div id="appScreen" class="hidden">
            <!-- êµ¬ì—­ ì„ íƒ (êµ¬ì—­ì¥ì´ ì—¬ëŸ¬ êµ¬ì—­ ë‹´ë‹¹ ì‹œ) -->
            <div class="cell-selector" id="cellSelector">
                <select class="cell-select" id="cellSelect" onchange="onCellChange()">
                    <!-- ë™ì  ìƒì„± -->
                </select>
            </div>
            
            <!-- íƒ­ ì»¨í…ì¸ : ì¶œì„ì²´í¬ -->
            <div id="tabAttendance">
                <div class="date-selector">
                    <span>ğŸ“…</span>
                    <input type="date" class="date-input" id="attendanceDate" onchange="loadAttendance()">
                    <button class="btn btn-secondary" onclick="setToday()" style="width: auto; padding: 10px 15px;">ì˜¤ëŠ˜</button>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <span>âœ…</span>
                        <span id="attendanceTitle">ì¶œì„ ì²´í¬</span>
                    </div>
                    
                    <div class="stats-row">
                        <div class="stat-box">
                            <div class="stat-number" id="statTotal">0</div>
                            <div class="stat-label">ì „ì²´</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="statPresent" style="color: #16a34a;">0</div>
                            <div class="stat-label">ì¶œì„</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="statAbsent" style="color: #dc2626;">0</div>
                            <div class="stat-label">ê²°ì„</div>
                        </div>
                    </div>
                    
                    <div id="memberList">
                        <!-- ë™ì  ìƒì„± -->
                    </div>
                </div>
                
                <div style="padding: 15px;">
                    <button class="btn btn-success" onclick="saveAttendance()">ğŸ’¾ ì¶œì„ ì €ì¥</button>
                </div>
            </div>
            
            <!-- íƒ­ ì»¨í…ì¸ : ë³´ê³ ì„œ -->
            <div id="tabReport" class="hidden">
                <div class="date-selector">
                    <span>ğŸ“…</span>
                    <input type="date" class="date-input" id="reportDate">
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <span>ğŸ“</span>
                        <span>êµ¬ì—­ì˜ˆë°° ë³´ê³ ì„œ</span>
                    </div>
                    
                    <div class="report-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ì˜ˆë°° ì¥ì†Œ</label>
                                <input type="text" class="form-input" id="reportPlace" placeholder="ì˜ˆ: ê¹€ì² ìˆ˜ ì§‘">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ì˜ˆë°° ì‹œê°„</label>
                                <input type="time" class="form-input" id="reportTime" value="14:00">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ì¸ë„ì</label>
                            <input type="text" class="form-input" id="reportLeader" placeholder="ì¸ë„ì ì´ë¦„">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ì°¬ì–‘</label>
                            <input type="text" class="form-input" id="reportHymn" placeholder="ì˜ˆ: ì°¬ì†¡ê°€ 94ì¥">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ì„±ê²½ ë³¸ë¬¸</label>
                                <input type="text" class="form-input" id="reportScripture" placeholder="ì˜ˆ: ë§ˆíƒœë³µìŒ 5:1-12">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ë§ì”€ ì œëª©</label>
                                <input type="text" class="form-input" id="reportTitle" placeholder="ë§ì”€ ì œëª©">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">êµ¬ì—­ í—Œê¸ˆ ($)</label>
                            <input type="number" class="form-input" id="reportOffering" placeholder="0" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ê¸°ë„ì œëª©</label>
                            <textarea class="form-textarea" id="reportPrayer" placeholder="êµ¬ì—­ì›ë“¤ì˜ ê¸°ë„ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">íŠ¹ì´ì‚¬í•­ / ë‚˜ëˆ”</label>
                            <textarea class="form-textarea" id="reportNotes" placeholder="ìƒˆì‹ ì, ê°ì‚¬, ë‚˜ëˆ” ë“±"></textarea>
                        </div>
                    </div>
                </div>
                
                <div style="padding: 15px;">
                    <button class="btn btn-primary" onclick="submitReport()">ğŸ“¤ ë³´ê³ ì„œ ì œì¶œ</button>
                </div>
            </div>
            
            <!-- íƒ­ ì»¨í…ì¸ : í˜„í™© (ê´€ë¦¬ììš©) -->
            <div id="tabOverview" class="hidden">
                <div class="overview-card">
                    <div class="overview-title" id="overviewDateTitle">12ì›” 8ì¼ êµ¬ì—­ì˜ˆë°° í˜„í™©</div>
                    <div class="overview-stats">
                        <div class="overview-stat">
                            <div class="overview-number" id="overviewSubmitted">0</div>
                            <div class="overview-label">ë³´ê³ ì„œ ì œì¶œ</div>
                        </div>
                        <div class="overview-stat">
                            <div class="overview-number" id="overviewTotal">0</div>
                            <div class="overview-label">ì „ì²´ êµ¬ì—­</div>
                        </div>
                        <div class="overview-stat">
                            <div class="overview-number" id="overviewAttendance">0</div>
                            <div class="overview-label">ì´ ì°¸ì„</div>
                        </div>
                        <div class="overview-stat">
                            <div class="overview-number" id="overviewOffering">$0</div>
                            <div class="overview-label">ì´ í—Œê¸ˆ</div>
                        </div>
                    </div>
                </div>
                
                <div class="date-selector">
                    <span>ğŸ“…</span>
                    <input type="date" class="date-input" id="overviewDate" onchange="loadOverview()">
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <span>ğŸ“Š</span>
                        <span>êµ¬ì—­ë³„ í˜„í™©</span>
                    </div>
                    <div id="overviewList">
                        <!-- ë™ì  ìƒì„± -->
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <span>ğŸ™</span>
                        <span>ê¸ˆì£¼ ê¸°ë„ì œëª©</span>
                    </div>
                    <div id="prayerList">
                        <!-- ë™ì  ìƒì„± -->
                    </div>
                </div>
            </div>
            
            <!-- íƒ­ ì»¨í…ì¸ : ê¸°ë¡ -->
            <div id="tabHistory" class="hidden">
                <div class="card">
                    <div class="card-title">
                        <span>ğŸ“š</span>
                        <span>ì§€ë‚œ ë³´ê³ ì„œ</span>
                    </div>
                    <div id="historyList">
                        <!-- ë™ì  ìƒì„± -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- í•˜ë‹¨ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="tab-nav hidden" id="tabNav">
        <button class="tab-btn active" onclick="showTab('attendance')" id="tabBtnAttendance">
            <span class="tab-icon">âœ…</span>
            <span>ì¶œì„</span>
        </button>
        <button class="tab-btn" onclick="showTab('report')" id="tabBtnReport">
            <span class="tab-icon">ğŸ“</span>
            <span>ë³´ê³ ì„œ</span>
        </button>
        <button class="tab-btn hidden" onclick="showTab('overview')" id="tabBtnOverview">
            <span class="tab-icon">ğŸ“Š</span>
            <span>í˜„í™©</span>
        </button>
        <button class="tab-btn" onclick="showTab('history')" id="tabBtnHistory">
            <span class="tab-icon">ğŸ“š</span>
            <span>ê¸°ë¡</span>
        </button>
    </div>
    
    <!-- ê²°ì„ ì‚¬ìœ  ëª¨ë‹¬ -->
    <div class="modal" id="reasonModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ê²°ì„ ì‚¬ìœ  ì…ë ¥</h3>
                <button class="modal-close" onclick="closeReasonModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reasonMemberId">
                <div class="form-group">
                    <label class="form-label">ê²°ì„ì: <strong id="reasonMemberName"></strong></label>
                </div>
                <div class="form-group">
                    <label class="form-label">ê²°ì„ ì‚¬ìœ </label>
                    <select class="form-input" id="reasonSelect" onchange="onReasonSelect()">
                        <option value="">-- ì„ íƒ --</option>
                        <option value="ì¶œì¥">ì¶œì¥</option>
                        <option value="ì—¬í–‰">ì—¬í–‰</option>
                        <option value="ì•„í””">ì•„í””/ë³‘ì›</option>
                        <option value="ê°€ì¡±í–‰ì‚¬">ê°€ì¡± í–‰ì‚¬</option>
                        <option value="ì§ì¥">ì§ì¥ ê·¼ë¬´</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€ (ì§ì ‘ì…ë ¥)</option>
                    </select>
                </div>
                <div class="form-group" id="customReasonGroup" style="display: none;">
                    <label class="form-label">ì‚¬ìœ  ì…ë ¥</label>
                    <input type="text" class="form-input" id="customReason" placeholder="ê²°ì„ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeReasonModal()" style="width: auto;">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveReason()" style="width: auto;">ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <!-- ë³´ê³ ì„œ ìƒì„¸ ëª¨ë‹¬ -->
    <div class="modal" id="reportDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="reportDetailTitle">ë³´ê³ ì„œ ìƒì„¸</h3>
                <button class="modal-close" onclick="closeReportDetail()">Ã—</button>
            </div>
            <div class="modal-body" id="reportDetailContent">
                <!-- ë™ì  ìƒì„± -->
            </div>
        </div>
    </div>
    
    <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
    <div class="toast" id="toast"></div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase ì„¤ì • (ë©”ì¸ ì‹œìŠ¤í…œê³¼ ë™ì¼)
        const firebaseConfig = {
            apiKey: "AIzaSyDxGpjfG5Rfpc8M5-k_xhmt7eYHhwGeVVU",
            authDomain: "gkc-web-project-c87c9.firebaseapp.com",
            projectId: "gkc-web-project-c87c9",
            storageBucket: "gkc-web-project-c87c9.firebasestorage.app",
            messagingSenderId: "842400243498",
            appId: "1:842400243498:web:2a79694db7a0343e4e3f4c"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let members = [];
        let cells = [];
        let cellAttendance = {};
        let cellReports = {};
        let absentReasons = {};
        let selectedCell = null;
        let attendanceData = {}; // í˜„ì¬ ë‚ ì§œì˜ ì¶œì„ ë°ì´í„°
        
        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            // ë‚ ì§œ ê¸°ë³¸ê°’ ì„¤ì • (ì´ë²ˆ ì£¼ì¼)
            setToday();
            
            // ì €ì¥ëœ ë¡œê·¸ì¸ ì •ë³´ í™•ì¸
            const savedUser = localStorage.getItem('cellAppUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                initApp();
            }
        });
        
        // ì´ë²ˆ ì£¼ì¼ ë‚ ì§œ ì„¤ì •
        function setToday() {
            const today = new Date();
            const sunday = new Date(today);
            sunday.setDate(today.getDate() - today.getDay()); // ì´ë²ˆ ì£¼ ì¼ìš”ì¼
            
            const dateStr = sunday.toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = dateStr;
            document.getElementById('reportDate').value = dateStr;
            document.getElementById('overviewDate').value = dateStr;
            
            loadAttendance();
        }
        
        // ë¡œê·¸ì¸
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showToast('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            try {
                // Firebaseì—ì„œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
                const usersDoc = await db.collection('registeredUsers').doc('main').get();
                if (!usersDoc.exists) {
                    showToast('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                const users = usersDoc.data().list || [];
                const user = users.find(u => u.username === username && u.password === password);
                
                if (!user) {
                    showToast('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤');
                    return;
                }
                
                // ê¶Œí•œ í™•ì¸ (êµ¬ì—­ê´€ë¦¬ ê¶Œí•œ ë˜ëŠ” ê´€ë¦¬ì)
                const hasAccess = user.role === 'ê´€ë¦¬ì' || 
                                  (user.permissions && user.permissions.includes('cell'));
                
                if (!hasAccess) {
                    showToast('êµ¬ì—­ê´€ë¦¬ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                currentUser = user;
                localStorage.setItem('cellAppUser', JSON.stringify(user));
                
                initApp();
                showToast('ë¡œê·¸ì¸ ì„±ê³µ!');
                
            } catch (error) {
                console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                showToast('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }
        
        // ì•± ì´ˆê¸°í™”
        async function initApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('tabNav').classList.remove('hidden');
            document.getElementById('logoutBtn').style.display = 'block';
            
            // ê´€ë¦¬ìë©´ í˜„í™© íƒ­ í‘œì‹œ
            if (currentUser.role === 'ê´€ë¦¬ì') {
                document.getElementById('tabBtnOverview').classList.remove('hidden');
            }
            
            // ë°ì´í„° ë¡œë“œ
            await loadData();
            
            // ì‹¤ì‹œê°„ ë™ê¸°í™” ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupRealtimeListeners();
            
            // êµ¬ì—­ ì„ íƒ ì´ˆê¸°í™”
            initCellSelector();
            
            // ì¶œì„ ë°ì´í„° ë¡œë“œ
            loadAttendance();
        }
        
        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            try {
                // êµì¸ ë°ì´í„°
                const membersDoc = await db.collection('churchMembers').doc('main').get();
                if (membersDoc.exists) {
                    members = membersDoc.data().list || [];
                }
                
                // êµ¬ì—­ ë°ì´í„°
                const cellsDoc = await db.collection('churchCells').doc('main').get();
                if (cellsDoc.exists) {
                    cells = cellsDoc.data().list || [];
                }
                
                // êµ¬ì—­ ì¶œì„ ë°ì´í„°
                const attDoc = await db.collection('cellAttendance').doc('main').get();
                if (attDoc.exists) {
                    cellAttendance = attDoc.data().data || {};
                }
                
                // êµ¬ì—­ ë³´ê³ ì„œ ë°ì´í„°
                const reportsDoc = await db.collection('cellReports').doc('main').get();
                if (reportsDoc.exists) {
                    cellReports = reportsDoc.data().data || {};
                }
                
                // ê²°ì„ ì‚¬ìœ 
                const reasonsDoc = await db.collection('absentReasons').doc('main').get();
                if (reasonsDoc.exists) {
                    absentReasons = reasonsDoc.data().data || {};
                }
                
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                showToast('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }
        
        // ì‹¤ì‹œê°„ ë™ê¸°í™” ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupRealtimeListeners() {
            console.log('ğŸ”„ ì‹¤ì‹œê°„ ë™ê¸°í™” ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì¤‘...');
            
            // êµ¬ì—­ ì¶œì„ ì‹¤ì‹œê°„ ë™ê¸°í™”
            db.collection('cellAttendance').doc('main').onSnapshot(doc => {
                if (doc.exists && doc.data().data) {
                    const newData = doc.data().data;
                    if (JSON.stringify(newData) !== JSON.stringify(cellAttendance)) {
                        console.log('ğŸ”„ êµ¬ì—­ ì¶œì„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸');
                        cellAttendance = newData;
                        loadAttendance();
                    }
                }
            });
            
            // êµ¬ì—­ ë³´ê³ ì„œ ì‹¤ì‹œê°„ ë™ê¸°í™”
            db.collection('cellReports').doc('main').onSnapshot(doc => {
                if (doc.exists && doc.data().data) {
                    const newData = doc.data().data;
                    if (JSON.stringify(newData) !== JSON.stringify(cellReports)) {
                        console.log('ğŸ”„ êµ¬ì—­ ë³´ê³ ì„œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸');
                        cellReports = newData;
                        if (currentUser.role === 'ê´€ë¦¬ì') {
                            loadOverview();
                        }
                        loadHistory();
                    }
                }
            });
            
            // ê²°ì„ ì‚¬ìœ  ì‹¤ì‹œê°„ ë™ê¸°í™”
            db.collection('absentReasons').doc('main').onSnapshot(doc => {
                if (doc.exists && doc.data().data) {
                    const newData = doc.data().data;
                    if (JSON.stringify(newData) !== JSON.stringify(absentReasons)) {
                        console.log('ğŸ”„ ê²°ì„ ì‚¬ìœ  ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸');
                        absentReasons = newData;
                        loadAttendance();
                    }
                }
            });
            
            // êµì¸ ë°ì´í„° ì‹¤ì‹œê°„ ë™ê¸°í™”
            db.collection('churchMembers').doc('main').onSnapshot(doc => {
                if (doc.exists && doc.data().list) {
                    const newData = doc.data().list;
                    if (JSON.stringify(newData) !== JSON.stringify(members)) {
                        console.log('ğŸ”„ êµì¸ ë°ì´í„° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸:', newData.length + 'ëª…');
                        members = newData;
                        loadAttendance();
                    }
                }
            });
            
            // êµ¬ì—­ ë°ì´í„° ì‹¤ì‹œê°„ ë™ê¸°í™”
            db.collection('churchCells').doc('main').onSnapshot(doc => {
                if (doc.exists && doc.data().list) {
                    const newData = doc.data().list;
                    if (JSON.stringify(newData) !== JSON.stringify(cells)) {
                        console.log('ğŸ”„ êµ¬ì—­ ë°ì´í„° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸:', newData.length + 'ê°œ');
                        cells = newData;
                        initCellSelector();
                    }
                }
            });
            
            console.log('âœ… ì‹¤ì‹œê°„ ë™ê¸°í™” ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ!');
            showToast('ğŸ”„ ì‹¤ì‹œê°„ ë™ê¸°í™” í™œì„±í™”ë¨');
        }
        
        // êµ¬ì—­ ì„ íƒ ì´ˆê¸°í™”
        function initCellSelector() {
            const select = document.getElementById('cellSelect');
            select.innerHTML = '';
            
            // ê´€ë¦¬ìëŠ” ëª¨ë“  êµ¬ì—­, êµ¬ì—­ì¥ì€ ìê¸° êµ¬ì—­ë§Œ
            let availableCells = [];
            
            if (currentUser.role === 'ê´€ë¦¬ì') {
                availableCells = cells;
            } else {
                // êµ¬ì—­ì¥ì¸ êµ¬ì—­ ì°¾ê¸°
                availableCells = cells.filter(c => c.leaderName === currentUser.name);
                
                // êµ¬ì—­ì¥ì´ ì•„ë‹ˆë©´ ì†Œì† êµ¬ì—­
                if (availableCells.length === 0) {
                    const member = members.find(m => m.nameKr === currentUser.name);
                    if (member && member.cell) {
                        const cellName = member.cell.replace('êµ¬ì—­', '');
                        const cell = cells.find(c => c.name === cellName || c.name === member.cell);
                        if (cell) availableCells = [cell];
                    }
                }
            }
            
            if (availableCells.length === 0) {
                select.innerHTML = '<option value="">ì ‘ê·¼ ê°€ëŠ¥í•œ êµ¬ì—­ì´ ì—†ìŠµë‹ˆë‹¤</option>';
                return;
            }
            
            availableCells.forEach((cell, idx) => {
                const option = document.createElement('option');
                option.value = cell.name;
                option.textContent = `${cell.name}êµ¬ì—­ (êµ¬ì—­ì¥: ${cell.leaderName || 'ë¯¸ì§€ì •'})`;
                select.appendChild(option);
            });
            
            selectedCell = availableCells[0].name;
            
            // êµ¬ì—­ì´ 1ê°œë©´ ì…€ë ‰í„° ìˆ¨ê¹€
            if (availableCells.length === 1 && currentUser.role !== 'ê´€ë¦¬ì') {
                document.getElementById('cellSelector').style.display = 'none';
            }
            
            loadAttendance();
        }
        
        // êµ¬ì—­ ë³€ê²½
        function onCellChange() {
            selectedCell = document.getElementById('cellSelect').value;
            loadAttendance();
        }
        
        // ì¶œì„ ë°ì´í„° ë¡œë“œ
        function loadAttendance() {
            if (!selectedCell) return;
            
            const dateStr = document.getElementById('attendanceDate').value;
            const cell = cells.find(c => c.name === selectedCell);
            
            if (!cell) return;
            
            // í•´ë‹¹ êµ¬ì—­ êµ¬ì—­ì› ëª©ë¡
            const cellMembers = members.filter(m => {
                const memberCell = (m.cell || '').replace('êµ¬ì—­', '');
                return memberCell === selectedCell || m.cell === selectedCell + 'êµ¬ì—­';
            });
            
            // êµ¬ì—­ì¥ ì¶”ê°€
            if (cell.leaderName) {
                const leader = members.find(m => m.nameKr === cell.leaderName);
                if (leader && !cellMembers.find(m => m.nameKr === cell.leaderName)) {
                    cellMembers.unshift(leader);
                }
            }
            
            // ì œëª© ì—…ë°ì´íŠ¸
            document.getElementById('attendanceTitle').textContent = `${selectedCell}êµ¬ì—­ ì¶œì„ì²´í¬`;
            
            // í•´ë‹¹ ë‚ ì§œì˜ ì¶œì„ ë°ì´í„°
            const key = `${selectedCell}_${dateStr}`;
            const savedAttendance = cellAttendance[key] || [];
            
            // ì¶œì„ ë°ì´í„° ì´ˆê¸°í™”
            attendanceData = {};
            cellMembers.forEach(m => {
                attendanceData[m.nameKr] = savedAttendance.includes(m.nameKr);
            });
            
            // ëª©ë¡ ë Œë”ë§
            const container = document.getElementById('memberList');
            
            if (cellMembers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ‘¥</div>
                        <div>êµ¬ì—­ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                `;
                updateStats();
                return;
            }
            
            let html = '';
            cellMembers.forEach((m, idx) => {
                const isPresent = attendanceData[m.nameKr];
                const isLeader = m.nameKr === cell.leaderName;
                const reasonKey = `${selectedCell}_${dateStr}_${m.nameKr}`;
                const reason = absentReasons[reasonKey] || '';
                
                html += `
                    <div class="member-item">
                        <input type="checkbox" class="member-checkbox" 
                               ${isPresent ? 'checked' : ''} 
                               onchange="toggleAttendance('${m.nameKr}', this.checked)">
                        <div class="member-info">
                            <div class="member-name">
                                ${m.nameKr}
                                ${isLeader ? '<span style="color: #4f46e5; font-size: 0.8em;">(êµ¬ì—­ì¥)</span>' : ''}
                            </div>
                            <div class="member-phone">
                                <a href="tel:${m.phone}" class="phone-link">${m.phone || '-'}</a>
                            </div>
                        </div>
                        ${isPresent ? 
                            '<span class="member-status status-present">ì¶œì„</span>' :
                            `<button class="reason-btn" onclick="openReasonModal('${m.nameKr}')">${reason || 'ì‚¬ìœ ì…ë ¥'}</button>`
                        }
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateStats();
        }
        
        // ì¶œì„ í† ê¸€
        function toggleAttendance(name, checked) {
            attendanceData[name] = checked;
            loadAttendance(); // ë‹¤ì‹œ ë Œë”ë§
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            const total = Object.keys(attendanceData).length;
            const present = Object.values(attendanceData).filter(v => v).length;
            const absent = total - present;
            
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statPresent').textContent = present;
            document.getElementById('statAbsent').textContent = absent;
        }
        
        // ê²°ì„ ì‚¬ìœ  ëª¨ë‹¬ ì—´ê¸°
        function openReasonModal(name) {
            const dateStr = document.getElementById('attendanceDate').value;
            const reasonKey = `${selectedCell}_${dateStr}_${name}`;
            const savedReason = absentReasons[reasonKey] || '';
            
            document.getElementById('reasonMemberId').value = name;
            document.getElementById('reasonMemberName').textContent = name;
            document.getElementById('reasonSelect').value = '';
            document.getElementById('customReason').value = '';
            document.getElementById('customReasonGroup').style.display = 'none';
            
            // ê¸°ì¡´ ì‚¬ìœ ê°€ ìˆìœ¼ë©´ ì„¤ì •
            if (savedReason) {
                const options = ['ì¶œì¥', 'ì—¬í–‰', 'ì•„í””', 'ê°€ì¡±í–‰ì‚¬', 'ì§ì¥'];
                if (options.includes(savedReason)) {
                    document.getElementById('reasonSelect').value = savedReason;
                } else {
                    document.getElementById('reasonSelect').value = 'ê¸°íƒ€';
                    document.getElementById('customReason').value = savedReason;
                    document.getElementById('customReasonGroup').style.display = 'block';
                }
            }
            
            document.getElementById('reasonModal').classList.add('active');
        }
        
        // ê²°ì„ ì‚¬ìœ  ì„ íƒ
        function onReasonSelect() {
            const value = document.getElementById('reasonSelect').value;
            document.getElementById('customReasonGroup').style.display = value === 'ê¸°íƒ€' ? 'block' : 'none';
        }
        
        // ê²°ì„ ì‚¬ìœ  ì €ì¥
        function saveReason() {
            const name = document.getElementById('reasonMemberId').value;
            const dateStr = document.getElementById('attendanceDate').value;
            let reason = document.getElementById('reasonSelect').value;
            
            if (reason === 'ê¸°íƒ€') {
                reason = document.getElementById('customReason').value.trim();
            }
            
            const reasonKey = `${selectedCell}_${dateStr}_${name}`;
            absentReasons[reasonKey] = reason;
            
            closeReasonModal();
            loadAttendance();
            showToast('ê²°ì„ ì‚¬ìœ ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
        
        // ëª¨ë‹¬ ë‹«ê¸°
        function closeReasonModal() {
            document.getElementById('reasonModal').classList.remove('active');
        }
        
        // ì¶œì„ ì €ì¥
        async function saveAttendance() {
            if (!selectedCell) return;
            
            const dateStr = document.getElementById('attendanceDate').value;
            const key = `${selectedCell}_${dateStr}`;
            
            // ì¶œì„ì ëª©ë¡
            const presentList = Object.keys(attendanceData).filter(name => attendanceData[name]);
            cellAttendance[key] = presentList;
            
            try {
                // Firebaseì— ì €ì¥
                await db.collection('cellAttendance').doc('main').set({ data: cellAttendance });
                await db.collection('absentReasons').doc('main').set({ data: absentReasons });
                
                showToast('âœ… ì¶œì„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }
        
        // ë³´ê³ ì„œ ì œì¶œ
        async function submitReport() {
            if (!selectedCell) return;
            
            const dateStr = document.getElementById('reportDate').value;
            
            const report = {
                cell: selectedCell,
                date: dateStr,
                place: document.getElementById('reportPlace').value,
                time: document.getElementById('reportTime').value,
                leader: document.getElementById('reportLeader').value,
                hymn: document.getElementById('reportHymn').value,
                scripture: document.getElementById('reportScripture').value,
                title: document.getElementById('reportTitle').value,
                offering: parseInt(document.getElementById('reportOffering').value) || 0,
                prayer: document.getElementById('reportPrayer').value,
                notes: document.getElementById('reportNotes').value,
                attendance: cellAttendance[`${selectedCell}_${dateStr}`] || [],
                submittedAt: new Date().toISOString(),
                submittedBy: currentUser.name
            };
            
            // í•„ìˆ˜ í•­ëª© í™•ì¸
            if (!report.place || !report.leader) {
                showToast('ì˜ˆë°° ì¥ì†Œì™€ ì¸ë„ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            const key = `${selectedCell}_${dateStr}`;
            cellReports[key] = report;
            
            try {
                await db.collection('cellReports').doc('main').set({ data: cellReports });
                showToast('ğŸ“¤ ë³´ê³ ì„œê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!');
                
                // í¼ ì´ˆê¸°í™”
                document.getElementById('reportPlace').value = '';
                document.getElementById('reportLeader').value = '';
                document.getElementById('reportHymn').value = '';
                document.getElementById('reportScripture').value = '';
                document.getElementById('reportTitle').value = '';
                document.getElementById('reportOffering').value = '';
                document.getElementById('reportPrayer').value = '';
                document.getElementById('reportNotes').value = '';
                
            } catch (error) {
                console.error('ì œì¶œ ì˜¤ë¥˜:', error);
                showToast('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }
        
        // í˜„í™© ë¡œë“œ (ê´€ë¦¬ììš©)
        async function loadOverview() {
            const dateStr = document.getElementById('overviewDate').value;
            const date = new Date(dateStr);
            const dateLabel = `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
            
            document.getElementById('overviewDateTitle').textContent = `${dateLabel} êµ¬ì—­ì˜ˆë°° í˜„í™©`;
            
            // í†µê³„ ê³„ì‚°
            let submitted = 0;
            let totalAttendance = 0;
            let totalOffering = 0;
            let prayers = [];
            
            let listHtml = '';
            
            cells.forEach(cell => {
                const key = `${cell.name}_${dateStr}`;
                const report = cellReports[key];
                const attendance = cellAttendance[key] || [];
                
                const cellMembers = members.filter(m => {
                    const memberCell = (m.cell || '').replace('êµ¬ì—­', '');
                    return memberCell === cell.name || m.cell === cell.name + 'êµ¬ì—­';
                });
                
                const totalMembers = cellMembers.length + (cell.leaderName ? 1 : 0);
                const attendanceRate = totalMembers > 0 ? Math.round((attendance.length / totalMembers) * 100) : 0;
                
                if (report) {
                    submitted++;
                    totalOffering += report.offering || 0;
                    if (report.prayer) {
                        prayers.push({ cell: cell.name, prayer: report.prayer });
                    }
                }
                
                totalAttendance += attendance.length;
                
                listHtml += `
                    <div class="report-item">
                        <div class="report-cell">${cell.name}êµ¬ì—­</div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.85em; color: #64748b;">
                                ì¶œì„ ${attendance.length}/${totalMembers}ëª… (${attendanceRate}%)
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${attendanceRate}%"></div>
                            </div>
                        </div>
                        <span class="report-status ${report ? 'report-submitted' : 'report-pending'}">
                            ${report ? 'âœ… ì œì¶œ' : 'â³ ë¯¸ì œì¶œ'}
                        </span>
                        ${report ? `<button class="report-view-btn" onclick="viewReport('${cell.name}', '${dateStr}')">ë³´ê¸°</button>` : ''}
                    </div>
                `;
            });
            
            document.getElementById('overviewSubmitted').textContent = submitted;
            document.getElementById('overviewTotal').textContent = cells.length;
            document.getElementById('overviewAttendance').textContent = totalAttendance;
            document.getElementById('overviewOffering').textContent = '$' + totalOffering;
            
            document.getElementById('overviewList').innerHTML = listHtml || '<div class="empty-state">êµ¬ì—­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            
            // ê¸°ë„ì œëª© ëª©ë¡
            let prayerHtml = '';
            prayers.forEach(p => {
                prayerHtml += `
                    <div class="prayer-item">
                        <div class="prayer-name">${p.cell}êµ¬ì—­</div>
                        <div class="prayer-content">${p.prayer}</div>
                    </div>
                `;
            });
            document.getElementById('prayerList').innerHTML = prayerHtml || '<div class="empty-state">ê¸°ë„ì œëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        }
        
        // ë³´ê³ ì„œ ìƒì„¸ ë³´ê¸°
        function viewReport(cellName, dateStr) {
            const key = `${cellName}_${dateStr}`;
            const report = cellReports[key];
            
            if (!report) return;
            
            const date = new Date(dateStr);
            const dateLabel = `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
            
            document.getElementById('reportDetailTitle').textContent = `${cellName}êµ¬ì—­ ë³´ê³ ì„œ (${dateLabel})`;
            
            document.getElementById('reportDetailContent').innerHTML = `
                <div style="display: grid; gap: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div><strong>ì˜ˆë°° ì¥ì†Œ:</strong> ${report.place || '-'}</div>
                        <div><strong>ì˜ˆë°° ì‹œê°„:</strong> ${report.time || '-'}</div>
                    </div>
                    <div><strong>ì¸ë„ì:</strong> ${report.leader || '-'}</div>
                    <div><strong>ì°¬ì–‘:</strong> ${report.hymn || '-'}</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div><strong>ë³¸ë¬¸:</strong> ${report.scripture || '-'}</div>
                        <div><strong>ì œëª©:</strong> ${report.title || '-'}</div>
                    </div>
                    <div><strong>ì°¸ì„ì (${report.attendance?.length || 0}ëª…):</strong> ${report.attendance?.join(', ') || '-'}</div>
                    <div><strong>êµ¬ì—­í—Œê¸ˆ:</strong> $${report.offering || 0}</div>
                    <div style="background: #fef3c7; padding: 15px; border-radius: 10px;">
                        <strong>ğŸ™ ê¸°ë„ì œëª©</strong>
                        <div style="margin-top: 10px; white-space: pre-wrap;">${report.prayer || '-'}</div>
                    </div>
                    <div style="background: #f1f5f9; padding: 15px; border-radius: 10px;">
                        <strong>ğŸ“ íŠ¹ì´ì‚¬í•­</strong>
                        <div style="margin-top: 10px; white-space: pre-wrap;">${report.notes || '-'}</div>
                    </div>
                    <div style="font-size: 0.8em; color: #94a3b8; text-align: right;">
                        ì œì¶œ: ${report.submittedBy || '-'} (${new Date(report.submittedAt).toLocaleString('ko-KR')})
                    </div>
                </div>
            `;
            
            document.getElementById('reportDetailModal').classList.add('active');
        }
        
        function closeReportDetail() {
            document.getElementById('reportDetailModal').classList.remove('active');
        }
        
        // ê¸°ë¡ ë¡œë“œ
        function loadHistory() {
            const container = document.getElementById('historyList');
            
            // í˜„ì¬ êµ¬ì—­ì˜ ë³´ê³ ì„œë§Œ (ë˜ëŠ” ê´€ë¦¬ìë©´ ì „ì²´)
            let reports = [];
            
            Object.keys(cellReports).forEach(key => {
                const report = cellReports[key];
                if (currentUser.role === 'ê´€ë¦¬ì' || report.cell === selectedCell) {
                    reports.push({ key, ...report });
                }
            });
            
            // ë‚ ì§œìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
            reports.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (reports.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“š</div><div>ì‘ì„±í•œ ë³´ê³ ì„œê°€ ì—†ìŠµë‹ˆë‹¤</div></div>';
                return;
            }
            
            let html = '';
            reports.slice(0, 20).forEach(report => {
                const date = new Date(report.date);
                const dateLabel = `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
                
                html += `
                    <div class="report-item" onclick="viewReport('${report.cell}', '${report.date}')">
                        <div class="report-cell">${report.cell}êµ¬ì—­</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${dateLabel}</div>
                            <div style="font-size: 0.8em; color: #64748b;">ì°¸ì„ ${report.attendance?.length || 0}ëª… | í—Œê¸ˆ $${report.offering || 0}</div>
                        </div>
                        <span style="color: #4f46e5;">â†’</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // íƒ­ ì „í™˜
        function showTab(tab) {
            // íƒ­ ì»¨í…ì¸ 
            document.getElementById('tabAttendance').classList.add('hidden');
            document.getElementById('tabReport').classList.add('hidden');
            document.getElementById('tabOverview').classList.add('hidden');
            document.getElementById('tabHistory').classList.add('hidden');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');
            
            // íƒ­ ë²„íŠ¼
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tabBtn' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            
            // íƒ­ë³„ ë°ì´í„° ë¡œë“œ
            if (tab === 'overview') {
                loadOverview();
            } else if (tab === 'history') {
                loadHistory();
            }
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            localStorage.removeItem('cellAppUser');
            currentUser = null;
            
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('tabNav').classList.add('hidden');
            document.getElementById('logoutBtn').style.display = 'none';
            
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            
            showToast('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤');
        }
        
        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // ===== ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡ =====
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker-cell.js')
                .then(reg => {
                    console.log('[Cell App] ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡ ì™„ë£Œ');
                    
                    // ì—…ë°ì´íŠ¸ ì²´í¬
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('[Cell App] ìƒˆ ë²„ì „ ë°œê²¬, ì—…ë°ì´íŠ¸ ì¤‘...');
                                showToast('ğŸ”„ ì•± ì—…ë°ì´íŠ¸ ì¤‘...');
                                newWorker.postMessage('skipWaiting');
                            }
                        });
                    });
                })
                .catch(err => console.error('[Cell App] ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡ ì‹¤íŒ¨:', err));
            
            // ìƒˆ ì„œë¹„ìŠ¤ì›Œì»¤ í™œì„±í™” ì‹œ ìƒˆë¡œê³ ì¹¨
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('[Cell App] ìƒˆ ë²„ì „ ì ìš©, ìƒˆë¡œê³ ì¹¨');
                window.location.reload();
            });
            
            // 1ë¶„ë§ˆë‹¤ ì—…ë°ì´íŠ¸ ì²´í¬
            setInterval(() => {
                navigator.serviceWorker.getRegistration().then(reg => {
                    if (reg) reg.update();
                });
            }, 60000);
        }
        
        // ===== ë„¤íŠ¸ì›Œí¬ ìƒíƒœ í‘œì‹œ =====
        function updateOnlineStatus() {
            if (navigator.onLine) {
                document.body.classList.remove('offline');
                console.log('[Cell App] ì˜¨ë¼ì¸ ìƒíƒœ');
            } else {
                document.body.classList.add('offline');
                showToast('ğŸ“´ ì˜¤í”„ë¼ì¸ ëª¨ë“œ - ì €ì¥ëœ ë°ì´í„°ë¡œ ì‘ë™ ì¤‘');
                console.log('[Cell App] ì˜¤í”„ë¼ì¸ ìƒíƒœ');
            }
        }
        
        window.addEventListener('online', () => {
            updateOnlineStatus();
            showToast('âœ… ì˜¨ë¼ì¸ ë³µê·€ - ë°ì´í„° ë™ê¸°í™” ì¤‘...');
            // ì˜¨ë¼ì¸ ë³µê·€ ì‹œ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
            if (currentUser) {
                loadData().then(() => {
                    loadAttendance();
                    showToast('âœ… ë™ê¸°í™” ì™„ë£Œ!');
                });
            }
        });
        
        window.addEventListener('offline', updateOnlineStatus);
        
        // ì´ˆê¸° ìƒíƒœ ì²´í¬
        updateOnlineStatus();
    </script>
</body>
</html>
