<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#059669">
    <title>GKC ë¶€ì„œê´€ë¦¬</title>
    <link rel="manifest" href="manifest-dept.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
            background: #f0fdf4;
            min-height: 100vh;
            color: #333;
        }
        
        /* í—¤ë” */
        .header {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
        }
        
        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content {
            padding-top: 70px;
            padding-bottom: 80px;
            min-height: 100vh;
        }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 70px);
            padding: 20px;
        }
        
        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            width: 100%;
            max-width: 350px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .login-logo {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .login-title {
            font-size: 1.5em;
            color: #059669;
            margin-bottom: 30px;
            font-weight: 700;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 0.9em;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1em;
            transition: border-color 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #059669;
        }
        
        /* ë²„íŠ¼ */
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }
        
        /* ì¹´ë“œ */
        .card {
            background: white;
            border-radius: 16px;
            margin: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .card-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* ë¶€ì„œ ì¹´ë“œ */
        .dept-card {
            background: white;
            border-radius: 16px;
            margin: 15px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .dept-header {
            padding: 20px;
            color: white;
        }
        
        .dept-name {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .dept-leader {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .dept-body {
            padding: 20px;
        }
        
        .dept-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }
        
        .dept-stat-number {
            font-size: 1.5em;
            font-weight: 700;
            color: #059669;
        }
        
        .dept-stat-label {
            font-size: 0.8em;
            color: #64748b;
        }
        
        /* íŒ€ ëª©ë¡ */
        .team-list {
            margin-top: 15px;
            border-top: 1px solid #e2e8f0;
            padding-top: 15px;
        }
        
        .team-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .team-item:last-child {
            border-bottom: none;
        }
        
        .team-name {
            font-weight: 600;
            color: #1e293b;
        }
        
        .team-count {
            background: #f0fdf4;
            color: #059669;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        /* êµ¬ì„±ì› ëª©ë¡ */
        .member-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            gap: 15px;
        }
        
        .member-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .member-info {
            flex: 1;
        }
        
        .member-name {
            font-weight: 600;
            color: #1e293b;
        }
        
        .member-role {
            font-size: 0.85em;
            color: #64748b;
        }
        
        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
        .tab-nav {
            display: flex;
            background: white;
            padding: 10px;
            gap: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
            background: #f1f5f9;
            color: #64748b;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }
        
        /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 20px;
            color: #94a3b8;
            text-decoration: none;
            font-size: 0.75em;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .nav-item.active {
            color: #059669;
        }
        
        .nav-icon {
            font-size: 1.5em;
            margin-bottom: 4px;
        }
        
        /* ë¹ˆ ìƒíƒœ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
        }
        
        .empty-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        /* ìˆ¨ê¹€ */
        .hidden {
            display: none !important;
        }
        
        /* í† ìŠ¤íŠ¸ */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 0.9em;
            z-index: 300;
            display: none;
        }
        
        .toast.show {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        /* ê²°ì¬ ìš”ì²­ */
        .request-card {
            background: white;
            border-radius: 12px;
            margin: 10px 15px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 4px solid #f59e0b;
        }
        
        .request-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .request-info {
            font-size: 0.85em;
            color: #64748b;
        }
        
        .request-amount {
            font-size: 1.2em;
            font-weight: 700;
            color: #059669;
            margin-top: 10px;
        }
        
        .request-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .request-actions .btn {
            flex: 1;
            padding: 10px;
            font-size: 0.9em;
        }
        
        .btn-approve {
            background: #059669;
            color: white;
        }
        
        .btn-reject {
            background: #ef4444;
            color: white;
        }
        
        /* ì˜¤í”„ë¼ì¸ */
        body.offline .header {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <div class="header">
        <h1>ğŸ›ï¸ GKC ë¶€ì„œê´€ë¦¬</h1>
        <button class="header-btn" id="logoutBtn" onclick="logout()" style="display: none;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    
    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="main-content">
        <!-- ë¡œê·¸ì¸ í™”ë©´ -->
        <div id="loginScreen" class="login-container">
            <div class="login-box">
                <div class="login-logo">ğŸ›ï¸</div>
                <div class="login-title">GKC ë¶€ì„œê´€ë¦¬</div>
                <div class="form-group">
                    <label class="form-label">ì•„ì´ë””</label>
                    <input type="text" class="form-input" id="loginUsername" placeholder="ì•„ì´ë”” ì…ë ¥">
                </div>
                <div class="form-group">
                    <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeypress="if(event.key==='Enter') login()">
                </div>
                <button class="btn btn-primary" onclick="login()">ë¡œê·¸ì¸</button>
            </div>
        </div>
        
        <!-- ì•± í™”ë©´ (ë¡œê·¸ì¸ í›„) -->
        <div id="appScreen" class="hidden">
            <!-- íƒ­: ë¶€ì„œ ëª©ë¡ -->
            <div id="tabDeptList">
                <div id="deptList">
                    <!-- ë™ì  ìƒì„± -->
                </div>
            </div>
            
            <!-- íƒ­: ë‚´ ë¶€ì„œ ìƒì„¸ -->
            <div id="tabMyDept" class="hidden">
                <div id="myDeptContent">
                    <!-- ë™ì  ìƒì„± -->
                </div>
            </div>
            
            <!-- íƒ­: ê²°ì¬ ìš”ì²­ (ë‹´ë‹¹ììš©) -->
            <div id="tabRequests" class="hidden">
                <div class="card">
                    <div class="card-title">ğŸ“‹ ê²°ì¬ ëŒ€ê¸° ëª©ë¡</div>
                    <div id="requestList">
                        <!-- ë™ì  ìƒì„± -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="bottom-nav hidden" id="bottomNav">
        <div class="nav-item active" onclick="showTab('deptList')">
            <div class="nav-icon">ğŸ›ï¸</div>
            <span>ë¶€ì„œ</span>
        </div>
        <div class="nav-item" onclick="showTab('myDept')">
            <div class="nav-icon">ğŸ‘¤</div>
            <span>ë‚´ ë¶€ì„œ</span>
        </div>
        <div class="nav-item" id="navRequests" onclick="showTab('requests')" style="display: none;">
            <div class="nav-icon">ğŸ“‹</div>
            <span>ê²°ì¬</span>
        </div>
    </div>
    
    <!-- í† ìŠ¤íŠ¸ -->
    <div class="toast" id="toast"></div>
    
    <script>
        // Firebase ì´ˆê¸°í™”
        const firebaseConfig = {
            apiKey: "AIzaSyD-9Mfa2t5z6t9z9z9z9z9z9z9z9z9z9z9",
            authDomain: "gkc-web-project-c87c9.firebaseapp.com",
            projectId: "gkc-web-project-c87c9",
            storageBucket: "gkc-web-project-c87c9.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abc123"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let departments = [];
        let members = [];
        let users = [];
        let paymentRequests = [];
        
        // ë¡œê·¸ì¸
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showToast('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            // Firebaseì—ì„œ ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ
            try {
                const usersDoc = await db.collection('registeredUsers').doc('main').get();
                if (usersDoc.exists) {
                    users = usersDoc.data().list || [];
                }
            } catch (e) {
                console.error('ì‚¬ìš©ì ë¡œë“œ ì‹¤íŒ¨:', e);
                users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            }
            
            // ê´€ë¦¬ì ê³„ì •
            if (username === 'gkc8127' && password === '4581') {
                currentUser = {
                    username: 'gkc8127',
                    name: 'ì •ì¤€ì—°',
                    role: 'ê´€ë¦¬ì',
                    permissions: ['department', 'offeringEdit']
                };
            } else {
                // ì¼ë°˜ ì‚¬ìš©ì
                const user = users.find(u => u.username === username && u.password === password);
                if (!user) {
                    showToast('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤');
                    return;
                }
                
                if (!user.permissions?.includes('department')) {
                    showToast('ë¶€ì„œê´€ë¦¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                currentUser = {
                    username: user.username,
                    name: user.name,
                    role: user.role,
                    permissions: user.permissions || [],
                    memberName: user.memberName
                };
            }
            
            // ë¡œê·¸ì¸ ì„±ê³µ
            localStorage.setItem('deptAppUser', JSON.stringify(currentUser));
            
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('bottomNav').classList.remove('hidden');
            document.getElementById('logoutBtn').style.display = 'block';
            
            // ê²°ì¬ ê¶Œí•œì´ ìˆìœ¼ë©´ ê²°ì¬ íƒ­ í‘œì‹œ
            if (currentUser.role === 'ê´€ë¦¬ì' || currentUser.permissions?.includes('offeringEdit')) {
                document.getElementById('navRequests').style.display = 'flex';
            }
            
            await loadData();
            renderDeptList();
            
            showToast('ë¡œê·¸ì¸ ì„±ê³µ!');
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            currentUser = null;
            localStorage.removeItem('deptAppUser');
            
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('bottomNav').classList.add('hidden');
            document.getElementById('logoutBtn').style.display = 'none';
            
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }
        
        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            try {
                // ë¶€ì„œ ë°ì´í„°
                const deptDoc = await db.collection('departments').doc('main').get();
                if (deptDoc.exists) {
                    departments = deptDoc.data().list || [];
                }
                
                // êµì¸ ë°ì´í„°
                const membersDoc = await db.collection('churchMembers').doc('main').get();
                if (membersDoc.exists) {
                    members = membersDoc.data().list || [];
                }
                
                // ê²°ì¬ ìš”ì²­
                const requestsDoc = await db.collection('paymentRequests').doc('main').get();
                if (requestsDoc.exists) {
                    paymentRequests = requestsDoc.data().list || [];
                }
                
                // localStorage ë°±ì—…
                localStorage.setItem('departments', JSON.stringify(departments));
                localStorage.setItem('churchMembers', JSON.stringify(members));
                localStorage.setItem('paymentRequests', JSON.stringify(paymentRequests));
                
            } catch (e) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
                // ì˜¤í”„ë¼ì¸ - localStorageì—ì„œ ë¡œë“œ
                departments = JSON.parse(localStorage.getItem('departments') || '[]');
                members = JSON.parse(localStorage.getItem('churchMembers') || '[]');
                paymentRequests = JSON.parse(localStorage.getItem('paymentRequests') || '[]');
            }
        }
        
        // ë¶€ì„œ ëª©ë¡ ë Œë”ë§
        function renderDeptList() {
            const container = document.getElementById('deptList');
            
            if (departments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ›ï¸</div>
                        <p>ë“±ë¡ëœ ë¶€ì„œê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                `;
                return;
            }
            
            const colors = ['#059669', '#0ea5e9', '#8b5cf6', '#f59e0b', '#ef4444', '#ec4899'];
            
            let html = '';
            departments.forEach((dept, idx) => {
                const color = colors[idx % colors.length];
                const deptMembers = members.filter(m => m.department === dept.name);
                const teams = dept.teams || [];
                
                html += `
                    <div class="dept-card" onclick="showDeptDetail(${idx})">
                        <div class="dept-header" style="background: linear-gradient(135deg, ${color} 0%, ${color}dd 100%);">
                            <div class="dept-name">${dept.name}</div>
                            <div class="dept-leader">ğŸ‘¤ ${dept.leader || 'ë¯¸ì •'}</div>
                        </div>
                        <div class="dept-body">
                            <div class="dept-stats">
                                <div>
                                    <div class="dept-stat-number">${deptMembers.length}</div>
                                    <div class="dept-stat-label">êµ¬ì„±ì›</div>
                                </div>
                                <div>
                                    <div class="dept-stat-number">${teams.length}</div>
                                    <div class="dept-stat-label">íŒ€</div>
                                </div>
                                <div>
                                    <div class="dept-stat-number">${dept.budget ? Math.round(dept.budget/10000) + 'ë§Œ' : '-'}</div>
                                    <div class="dept-stat-label">ì˜ˆì‚°</div>
                                </div>
                            </div>
                            ${teams.length > 0 ? `
                                <div class="team-list">
                                    ${teams.slice(0, 3).map(team => `
                                        <div class="team-item">
                                            <span class="team-name">${team.name}</span>
                                            <span class="team-count">${team.members?.length || 0}ëª…</span>
                                        </div>
                                    `).join('')}
                                    ${teams.length > 3 ? `<div style="text-align: center; color: #94a3b8; font-size: 0.85em; padding-top: 10px;">+${teams.length - 3}ê°œ ë”ë³´ê¸°</div>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ë¶€ì„œ ìƒì„¸
        function showDeptDetail(idx) {
            const dept = departments[idx];
            if (!dept) return;
            
            showTab('myDept');
            
            const container = document.getElementById('myDeptContent');
            const deptMembers = members.filter(m => m.department === dept.name);
            const teams = dept.teams || [];
            const colors = ['#059669', '#0ea5e9', '#8b5cf6', '#f59e0b', '#ef4444', '#ec4899'];
            const color = colors[idx % colors.length];
            
            let html = `
                <div class="dept-card">
                    <div class="dept-header" style="background: linear-gradient(135deg, ${color} 0%, ${color}dd 100%);">
                        <div class="dept-name">${dept.name}</div>
                        <div class="dept-leader">ğŸ‘¤ ë¶€ì¥: ${dept.leader || 'ë¯¸ì •'}</div>
                    </div>
                    <div class="dept-body">
                        <div class="dept-stats">
                            <div>
                                <div class="dept-stat-number">${deptMembers.length}</div>
                                <div class="dept-stat-label">êµ¬ì„±ì›</div>
                            </div>
                            <div>
                                <div class="dept-stat-number">${teams.length}</div>
                                <div class="dept-stat-label">íŒ€</div>
                            </div>
                            <div>
                                <div class="dept-stat-number">${dept.budget ? Math.round(dept.budget/10000) + 'ë§Œì›' : '-'}</div>
                                <div class="dept-stat-label">ì˜ˆì‚°</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- íŒ€ ëª©ë¡ -->
                ${teams.length > 0 ? `
                    <div class="card">
                        <div class="card-title">ğŸ‘¥ ì†Œì† íŒ€</div>
                        ${teams.map(team => `
                            <div class="team-item">
                                <div>
                                    <div class="team-name">${team.name}</div>
                                    <div style="font-size: 0.8em; color: #64748b;">íŒ€ì¥: ${team.leader || 'ë¯¸ì •'}</div>
                                </div>
                                <span class="team-count">${team.members?.length || 0}ëª…</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <!-- êµ¬ì„±ì› ëª©ë¡ -->
                <div class="card">
                    <div class="card-title">ğŸ‘¤ êµ¬ì„±ì› (${deptMembers.length}ëª…)</div>
                    ${deptMembers.length > 0 ? deptMembers.map(m => `
                        <div class="member-item">
                            <div class="member-avatar" style="background: ${color};">${m.nameKr?.charAt(0) || '?'}</div>
                            <div class="member-info">
                                <div class="member-name">${m.nameKr || '-'}</div>
                                <div class="member-role">${m.position || 'ì„±ë„'} ${m.phone ? 'Â· ' + m.phone : ''}</div>
                            </div>
                        </div>
                    `).join('') : '<div class="empty-state">ë“±ë¡ëœ êµ¬ì„±ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>'}
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // ê²°ì¬ ìš”ì²­ ëª©ë¡
        function renderRequests() {
            const container = document.getElementById('requestList');
            
            const pending = paymentRequests.filter(r => r.status === 'ëŒ€ê¸°ì¤‘' || r.status === 'ìŠ¹ì¸ëŒ€ê¸°');
            
            if (pending.length === 0) {
                container.innerHTML = '<div class="empty-state">ëŒ€ê¸°ì¤‘ì¸ ê²°ì¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            let html = '';
            pending.forEach((req, idx) => {
                html += `
                    <div class="request-card">
                        <div class="request-title">${req.title || 'ì§€ì¶œ ìš”ì²­'}</div>
                        <div class="request-info">
                            ${req.department || '-'} Â· ${req.requester || '-'} Â· ${req.date || '-'}
                        </div>
                        <div class="request-amount">â‚©${(req.amount || 0).toLocaleString()}</div>
                        <div class="request-actions">
                            <button class="btn btn-approve" onclick="approveRequest(${idx})">ìŠ¹ì¸</button>
                            <button class="btn btn-reject" onclick="rejectRequest(${idx})">ê±°ì ˆ</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ê²°ì¬ ìŠ¹ì¸
        async function approveRequest(idx) {
            const pending = paymentRequests.filter(r => r.status === 'ëŒ€ê¸°ì¤‘' || r.status === 'ìŠ¹ì¸ëŒ€ê¸°');
            const req = pending[idx];
            if (!req) return;
            
            req.status = 'ìŠ¹ì¸';
            req.approvedBy = currentUser.name;
            req.approvedDate = new Date().toISOString().split('T')[0];
            
            try {
                await db.collection('paymentRequests').doc('main').set({ list: paymentRequests });
                localStorage.setItem('paymentRequests', JSON.stringify(paymentRequests));
                showToast('ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤');
                renderRequests();
            } catch (e) {
                showToast('ì €ì¥ ì‹¤íŒ¨');
            }
        }
        
        // ê²°ì¬ ê±°ì ˆ
        async function rejectRequest(idx) {
            const pending = paymentRequests.filter(r => r.status === 'ëŒ€ê¸°ì¤‘' || r.status === 'ìŠ¹ì¸ëŒ€ê¸°');
            const req = pending[idx];
            if (!req) return;
            
            const reason = prompt('ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (!reason) return;
            
            req.status = 'ê±°ì ˆ';
            req.rejectedBy = currentUser.name;
            req.rejectReason = reason;
            
            try {
                await db.collection('paymentRequests').doc('main').set({ list: paymentRequests });
                localStorage.setItem('paymentRequests', JSON.stringify(paymentRequests));
                showToast('ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤');
                renderRequests();
            } catch (e) {
                showToast('ì €ì¥ ì‹¤íŒ¨');
            }
        }
        
        // íƒ­ ì „í™˜
        function showTab(tab) {
            // ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
            document.getElementById('tabDeptList').classList.add('hidden');
            document.getElementById('tabMyDept').classList.add('hidden');
            document.getElementById('tabRequests').classList.add('hidden');
            
            // ëª¨ë“  ë„¤ë¹„ ë¹„í™œì„±í™”
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // ì„ íƒëœ íƒ­ í‘œì‹œ
            if (tab === 'deptList') {
                document.getElementById('tabDeptList').classList.remove('hidden');
                document.querySelectorAll('.nav-item')[0].classList.add('active');
                renderDeptList();
            } else if (tab === 'myDept') {
                document.getElementById('tabMyDept').classList.remove('hidden');
                document.querySelectorAll('.nav-item')[1].classList.add('active');
            } else if (tab === 'requests') {
                document.getElementById('tabRequests').classList.remove('hidden');
                document.getElementById('navRequests').classList.add('active');
                renderRequests();
            }
        }
        
        // í† ìŠ¤íŠ¸
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }
        
        // ì˜¤í”„ë¼ì¸ ê°ì§€
        window.addEventListener('online', () => {
            document.body.classList.remove('offline');
            loadData();
        });
        
        window.addEventListener('offline', () => {
            document.body.classList.add('offline');
        });
        
        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            // ì €ì¥ëœ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            const saved = localStorage.getItem('deptAppUser');
            if (saved) {
                currentUser = JSON.parse(saved);
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                document.getElementById('bottomNav').classList.remove('hidden');
                document.getElementById('logoutBtn').style.display = 'block';
                
                if (currentUser.role === 'ê´€ë¦¬ì' || currentUser.permissions?.includes('offeringEdit')) {
                    document.getElementById('navRequests').style.display = 'flex';
                }
                
                loadData().then(() => {
                    renderDeptList();
                });
            }
        });
    </script>
</body>
</html>
